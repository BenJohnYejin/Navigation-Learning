> * 翻译自俄语文章：https://habr.com/ru/articles/237859/
> * 项目链接：https://github.com/iliasam/SDR_projects

# FPGA 上的独立 SDR 接收机

早些时候，我写过一篇关于[在 DE0-nano 调试板基础上自制 SDR 接收器](http://habrahabr.ru/post/204310/)的文章。与其他大多数 SDR 接收器一样，它无法在没有计算机连接的情况下工作。同时，所使用的 FPGA 中仍有大量未使用的资源，因此我决定让接收器完全自主运行。

[TOC]

## 上一个项目的简介

任何接收机的任务都是放大来自天线的信号，分离出所需的高频信号，将其传输到低频（最常见的是音频），并解调得到的信号。在这种情况下，一个棘手的问题是如何从整个无线电空气中准确分配特定的高频信号。通常情况下，所需的信号位于一个相对较窄的频段内（大多数业余无线电信号的频带宽度小于 4 千赫），而旁边还有其他无线电信号，接收这些信号只会造成干扰。因此，模拟业余无线电接收机相当复杂，必须进行多次频率转换，并安装相当复杂的带通滤波器。由于存在不同的信号调制方法，接收机还需要一套不同的解调器。

随着强大计算技术的普及，现在可以将接收机的部分功能转移到计算机上。通过数字信号处理，可以创建非常有效的带通滤波器（尽管是低通滤波器），解调任何类型的信号，并显示接收信号的频谱。

在大多数现代接收机中，信号从较高频率向较低频率的转移是通过将原始信号与来自参考振荡器的信号混合（相乘）实现的--外差。因此，混频器输出端会出现一个频率等于原始信号和外差信号频率之差的信号。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112229972.png" alt="image-20240311112229972" style="zoom:50%;" />

不过，低于和高于外差频率（图中频率 A 和 B）的信号都能接收到。这种现象被称为 "镜像信道"。为了解决这个问题，模拟接收机使用滤波器，将信号一起传到中间频率。

还有另一种镜像信道抑制方法--相位法，使用信号的正交混频（[方法说明](http://www.radiostation.ru/drm/phasefilter.html)）。这种方法的特殊之处在于，要在接收器中实现这种方法，必须使用两个足够高阶的移相器，而且它们的特性必须相同，这就要求精确选择元件，并使接收器的设计和调整变得复杂。

由于可以用完全相同的方式对多个不同的信号进行数字化处理，因此可以制造出非常简单但有效的接收器。在这种接收机中，经过正交混频器的信号会从射频信号中过滤、放大，并由 ADC 进行数字化处理，然后发送到计算机或 DSP。大多数 SDR 接收器都采用这种技术。此类接收器的结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112336557.png" alt="image-20240311112336557" style="zoom:50%;" />

利用合适的高速 ADC 和 FPGA，甚至可以对产生的信号进行正交变换和解调。这种类型的接收器称为 DDC（数字下变频）。由于这种接收机几乎没有模拟元件，因此可以获得很高的 "镜像信道 "抑制比。我在前面介绍过这样一种接收机。它包括一个外部 ADC、FPGA 实现的信号乘法器、数字信号发生器、CIC 和 FIR 滤波器，以及将接收到的信息传输到计算机的模块。接收器通过以太网输出 16 位 x 50 ksps x 2 个通道的数据流。

现在我们来介绍一下能够自主运行的 SDR 接收器。

## 信号提取和解调

以前，在我的接收器中，这些操作都是由计算机执行的。现在有必要在 FPGA 上实现这些操作。
解调器结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112438888.png" alt="image-20240311112438888" style="zoom:50%;" />

由于希望能够在不改变接收机主频的情况下改变接收信号的频率，因此有必要在解调器单元中增加一个信号发生器和复乘法器。信号发生器（NCO1）可产生正弦波和余弦波，调谐范围为 0-25 kHz。

正交乘法器用于将所需信号传输到零频率区域。其工作的一个重要特点是，由于是对复数信号进行乘法运算，其输出端没有镜像通道。
还有一个模块可以交换连接 NCO1 和乘法器的总线，从而改变信号偏移的方向（图中未显示该模块）。信号偏移的结果：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112508967.png" alt="image-20240311112508967" style="zoom:50%;" />

然而，上述频率偏移并不能解决镜像通道问题。正交混频器输出端的信号相位取决于它们相对于外差频率的位置：高于该频率的信号在通道 I 和 Q 中的相位差为 +90，低于该频率的信号相位差为 -90。

因此，如果我们将通道 I 中的所有信号偏移 +90 度，信号的相位差要么为 180 度，要么为 0 度。只需将得到的信号相加，不需要的镜像通道就会被抑制（将相位差为 180 度的信号相加，结果为零）。如果将信号相减而不是相加，则会接收到镜像通道 - 这样就可以切换接收波段的类型：LSB/USB。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112538525.png" alt="image-20240311112538525" style="zoom:50%;" />

为了在解调器模块中进行相移，引入了数字相移滤波器--希尔伯特变换。它将信号的所有频率成分相移 90 度。该滤波器使用 Matlab 中的 FDATool 工具进行计算。事实上，希尔伯特滤波器只是一种具有特定系数的 FIR 滤波器。FDATool 甚至可以为滤波器生成 VHDL 代码。所用滤波器的阶数为 65。希尔伯特滤波器的特点是，在频率为 0 和 Fs/2 时，其透射率趋于 0。在这种情况下，这意味着从 0 到 ~500 Hz 的低频区域内的频率将不被接受。

希尔伯特滤波器会将信号延迟 N/2 个采样点，即滤波器的 N 阶。为了弥补这一影响，Q 通道引入了一条延迟线（FIFO 缓冲器），将信号延迟 34 个采样点。

将通道 I 和通道 Q 的信号相加后，产生的信号应经过滤波，以便输出 0-3 kHz 频段的信号。这样做是为了便于接收 SSB 信号，因为 SSB 信号通常有这样一个频段。需要注意的是，如果几个电报电台都在这个频段内，那么它们都能被听到。使用 Quartus 现成的 FIR 滤波器作为滤波器。它的阶数为 32，其系数也是在 FDATool 中计算得出的。结果滤波器的 AFC：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112632265.png" alt="image-20240311112632265" style="zoom:50%;" />

所有解调器模块的比特率都是 12 比特。比特率越低，音质越差；比特率越高，需要的 FPGA 资源越多，显然不够用。所有模块的时钟频率均为 50 kHz（抽取滤波器输出端的数据流速率）。

## 音频输出

为了从 FPGA 获取音频信号，我使用了 PWM 整形器。这并不是创建音频信号的最佳方法，但却是最简单的方法。PWM 整形器的时钟频率选择得相当高，达到 100 MHz。在此频率下，以 12 位比特率计算，PWM 脉冲频率为 24kHz。

由于接收信号的动态范围非常大，因此必须在设计中引入软件自动增益控制（AGC）以保证正常接收。它的实现非常简单--如果解调器输出端的信号幅度过高，AGC 模块就会对解调器输入端的信号进行衰减（解调器中的右移器块就是用于此目的）。信号通过简单的移位衰减 2^N 倍，虽然不太方便，但很容易在软件中实现，而且实际上不需要 FPGA 资源。如果解调器输出端的信号低电平持续 0.2 秒，信号衰减就会减小。这种方法的缺点是有时会听到增益切换的声音。

## FFT、频谱显示和接收器控制

在此之前，我已经在 DE0-nano 上实现了 VGA 监视器的工作。我还试验了 FFT 模块。因此，只需将现有模块转移到接收器项目中，并将抽取滤波器的输出端连接到 FFT 模块的输入端，就可以从主外差频率 NCO2 观察 +-25kHz 频段的无线电信号频谱。音频解调器和 FFT 独立工作，因此可以在不改变接收机调谐频率的情况下改变接收信号的频率。FFT 模块是 Quartus 现成的，长 512 点，可与窗口功能模块配合使用。

传统上，在显示频谱时会使用对数表示法。但是，我发现这种方法信息量不大，而且硬件对数计算模块占用了太多的 FPGA 资源，用程序计算对数的时间又太长。因此，在将频谱振幅值显示在屏幕上之前，只需将其缩小 2^N 倍，N 的数值可以通过编程更改。

在本项目中，FFT 模块的数据采集、VGA 屏幕的数据输出、SDRAM 的工作以及接收器的控制都是通过 SOPC 系统完成的，该系统包括一个软件处理器 NIOS II。SOPC 简化结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112749287.png" alt="image-20240311112749287" style="zoom:50%;" />

我决定使用 PS/2 接口的鼠标来控制接收器。这非常简单，所有通信都通过两根线进行。在 Altera 网站上的一些调试板示例中，明确提到了一种用于 SOPC 的模块，可以与 PS/2 配合使用。我还找到了代码（我不能给你链接，因为我又找不到必要的链接了）。我找到的示例必须经过修改才能与我的系统频率配合使用，但一开始仍然无法工作。PS/2 总线是双向的，电压为 5 伏，而 FPGA 的工作电压为 3.3 伏，因此情况变得更加复杂。结果发现，为了让鼠标正常工作，必须为其提供 5V 电压（3.3V 电压下鼠标无法启动），在 Quartus 设置中，PS/2 总线所用引脚应指定为 3.3V 工作电压（我的其他引脚设置为 2.5V）。我还必须在 CLK 线路和地线之间安装一个 470pF 的电容器，以确保可靠运行。如果使用外部电压电平转换器，也许可以避免这些问题。

然后，我设法通过 Nios 与鼠标建立了通信，但这里也有一个问题--我无法设置鼠标输出数据的频率。后来证明，这是一种特殊类型鼠标的问题。鼠标的软件操作并不复杂--移动时初始化后，它会向 FPGA 发送 3 个字节，由 SOPC 中的鼠标控制器接收。它还会为 Nios 生成一个中断，Nios 会在该中断的处理程序中计算新的光标坐标。

通过 Nios 实现的接口可以观察频谱、"瀑布"、控制接收器调谐（主外差）、音频接收频率调谐、接收波段类型 - USB/LSB。用鼠标左/右键点击频率指示器上的相应数字，即可改变调谐频率（同样，在许多计算机 SDR 程序中也可以改变频率）。用鼠标点击频谱或 "瀑布 "上所需的位置，即可更改音频接收的频率设置。整个接收器的结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311112841476.png" alt="image-20240311112841476" style="zoom:50%;" />

Quartus 中的图表如下：

![sdr2](https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/sdr2.png)

## 项目使用的 FPGA 资源

正如我在上文所写，由于项目规模较大，在创建过程中遇到了一些困难。它使用了大量滤波器，这些滤波器既占用了逻辑元件 (LE) 的空间，又使用了硬件乘法器。在设置每个模块的参数时，我们必须选择使用哪种长度的滤波器。由于缺乏资源，一些滤波器不得不切换到对称模式，这使得滤波器使用的乘法器数量减少了一半。尽管如此，解调器中的希尔伯特滤波器和 FIR 滤波器的参数还是相当一般（在计算机程序中它们要有效得多）。值得注意的是，在最终设计中，FPGA 资源没有得到充分利用--大多数模块的时钟频率为 50kHz，尽管它们可以在更高的频率下运行。

此外，SOPC 和 Nios 还占用了大量资源，超过 6000 LE。该项目总共使用了 LE: 21,445 / 22,320 (96 %)、9 位乘法器：98 / 132 (74 %)，可以看出，几乎使用了所有 LE FPGA。

接收器概览：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311113050167.png" alt="image-20240311113050167" style="zoom:50%;" />

特写镜头：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311113113191.png" alt="image-20240311113113191" style="zoom:50%;" />

操作过程中的屏幕视图（CQ WW RTTY DX Contest 期间）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311113133244.png" alt="image-20240311113133244" style="zoom:50%;" />

SSB 接收：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311113159364.png" alt="image-20240311113159364" style="zoom:50%;" />

从视频中可以判断接收器的质量。值得注意的是，用耳朵听到的声音要比用手机录制的视频稍好一些。另外，正如我在上一篇文章中提到的，使用的天线不是最好的。
接收机能够接收到 rtty 信号（与接收机连接的掌上电脑对其进行了解码），也能接收到 JT65 信号（在电脑上对其进行了解码）。还能听到德国广播电台发送的气象传真。
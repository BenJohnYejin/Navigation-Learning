> * 翻译自俄语文章：https://habr.com/ru/articles/327642/
> * 项目地址：https://github.com/iliasam/Laser_tape_reverse_engineering
> * 将激光测距仪模块连接到 Arduino 的说明：https://www.hackster.io/iliasam/making-a-cheap-laser-rangefinder-for-arduino-4dd849

# 激光测距仪的工作原理：逆向工程

在[前面的文章](https://habr.com/ru/post/213749/)中，我谈到了相位激光测距仪的工作原理。现在是时候了解家用激光测距仪的工作原理了。要了解的不仅仅是看看里面有什么，而是要完全重构整个电路，并编写自己的微控制器程序。

## 激光测距仪的工作原理

大多数激光测距仪使用相位而非脉冲（飞行时间，TOF）方法测量距离。为了本文的完整性，我将引用上一篇文章中的部分理论：

> 在相位法中，与脉冲法不同的是，激光器持续工作，但其辐射被一定频率（通常频率小于 500MHz）的信号调幅。需要注意的是，激光波长保持不变（在 500 - 1100 nm 范围内）。
>
> 光电探测器接收物体反射的辐射，并将其相位与来自激光的参考信号的相位进行比较。由于波的传播存在延迟，因此会产生相位偏移，测距仪会对其进行测量。
>
> <img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311153952864.png" alt="image-20240311153952864" style="zoom: 67%;" />
>
> 距离由公式确定：
> $$
> D=\frac{c}{2 f} \cdot \frac{\varphi}{2 \pi}
> $$
> 其中，c 为光速，f 为激光调制频率，phi 为相移。
>
> 这个公式只有在与物体的距离小于调制信号波长的一半（等于 c / 2f）时才有效。
>
> 如果调制频率等于 10 MHz，则测量距离可达 15 米，当距离从 0 米变为 15 米时，相位差将从 0 度变为 360 度。在这种情况下，1 度的相位变化相当于物体移动了约 4 厘米。
>
> 如果超过这个距离，就会产生模糊性--无法确定测量距离内适合多少个波段。为了解决这个模糊问题，需要切换激光调制频率，并求解由此产生的方程组。
>
> 最简单的情况是使用两个频率，低频用于近似确定物体的距离（但最大距离仍然有限），高频用于确定所需的距离精度--在相移测量精度相同的情况下，使用高频时距离测量精度会明显提高。
>
> 由于测量高精度相移的方法相对简单，此类测距仪的距离测量精度可低至 0.5 毫米。对精度要求较高的测距仪--大地测量测距仪、激光测距仪、安装在机器人上的扫描测距仪--都采用了相位原理。
>
>
> 不过，这种方法也有缺点--连续运行的激光器的辐射功率明显低于脉冲激光器，因此无法使用相位测距仪进行长距离测量。此外，以所需精度测量相位可能需要一些时间，从而限制了设备的速度。

如上所述，为了提高精度，需要提高激光辐射的调制频率。然而，要测量两个高频信号之间的相位差是很困难的。因此，相位测距仪通常采用外差信号转换技术。这种测距仪的结构图如下所示。我所考虑的激光测距仪就是这样设计的。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311154101682.png" alt="image-20240311154101682" style="zoom: 67%;" />

测距仪由两个高频振荡器组成，产生两个频率接近的信号。其中一个振荡器产生的信号送入激光器，另一个振荡器产生的信号（外差）与光电探测器接收到的信号相乘。由此产生的信号被送入一个低通滤波器（LPF），这样滤波器的输出端就只剩下差频信号了。该信号的振幅很小，必须经过放大后才能输入微控制器。值得注意的是，制作高增益的低频放大器要比制作高频放大器容易得多，这也是外差电路的一个优点。

由于相位测距仪测量的是信号的相位差，因此在设计中还需要另一个信号--参考信号。它通过将两个振荡器的信号相乘而得到。测距仪微控制器处理这两个低频信号，并计算它们之间的相位差。

值得一提的是，大多数激光测距仪使用雪崩光电二极管 (APD) 作为光电探测器。它们具有自己的内部信号放大功能，从而降低了对测距仪放大器组件的要求。这种光电二极管的增益与电源电压呈非线性关系。因此，如果 APD 的电源电压受到外差信号的调制，信号的混合（倍增）将直接在光电二极管本身进行。这就简化了测距仪的设计，减少了噪声的影响。同时，雪崩光电二极管也有许多缺点。这些缺点包括：

* 电源电压必须足够高 - 100 伏或更高。
* 参数对温度的依赖性很强。
* 成本过高（与其他光电二极管相比）。

## 激光测距仪的逆向工程

作为测试样品，我使用了在 Aliexpress 上找到的 "50M DIY 测距仪 "套件（右侧是附带测距仪的照片）。据我所知，这个套件是 "X-40 "激光测距仪的内件（现在售价 20 美元）。我之所以选择这个套件，只是因为它的照片显示了设备的电子元件。根据我掌握的信息，这款测距仪的电路与 U-NIT UT390B+ 测距仪以及其他国产激光测距仪和激光测距模块的电路非常接近。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311192759618.png" alt="image-20240311192759618" style="zoom: 67%;" />

在测试过程中，我只能在 10 米的距离内检查测距仪的性能。它的工作非常困难，测量时间超过 5 秒。我怀疑它甚至无法测量 20 米的距离，更不用说制造商声称的 50 米了。

这种测距仪的构造是怎样的？

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311192827570.png" alt="image-20240311192827570" style="zoom:50%;" />

从照片上可以看出，它非常简单。从结构上看，测距仪由一个激光测距装置、一个指示器和一块带按钮的电路板组成。显然，最有趣的部分是测距仪。这就是它的近景：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311192903747.png" alt="image-20240311192903747" style="zoom:50%;" />

电路板顶端有两个主要测距芯片--STM32F100C8T6 微控制器和 Si5351 双 PLL 振荡器。该芯片能够产生频率高达 200 MHz 的两个信号。激光调制信号和外差信号就是由它产生的。在电路板的这一侧，还有一个混频器和参考信号（REF）滤波器，以及 APD 的高压电压源组件的一些部件（照片顶部）。这就是测距仪组件底部的样子：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311192934179.png" alt="image-20240311192934179" style="zoom:50%;" />

从照片上可能看不清楚，但实际上你可以看到两块电路板--第二块电路板非常小，垂直安装。在这张照片中，你可以清楚地看到激光二极管的引线和一个小扬声器（它在工作时不断发出蜂鸣声，所以我后来把它焊掉了）。此外，这里还有构成测距仪电源电压的元件。在一块小电路板上有一个雪崩光电二极管，内置干扰光滤波器和接收信号放大器。这是从侧面看的电路板：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193014221.png" alt="image-20240311193014221" style="zoom:50%;" />

右图是雪崩光电二极管透过测距仪物镜的视图。下一步是重建测距仪电路。电路板相当小，虽然分了层，但并不复杂，因此重建电路的过程并不长。电路板照片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193043549.png" alt="image-20240311193043549" style="zoom: 67%;" />

在一家中国网上商店，我找到了一张激光测距仪模块（511F 版）[电路板的图片](https://ae01.alicdn.com/kf/HTB1h_f6PpXXXXbMXXXXq6xXFXXXC/123378680/HTB1h_f6PpXXXXbMXXXXq6xXFXXXC.jpg?size=388420&height=752&width=1000&hash=d2092bffecf6ad0b8d8ed0496e8cfd0b)，其设计与我的电路板（512A 版）非常接近。图片的分辨率很低，但它显示了导线的位置和芯片下面的过渡孔。后来我在上面签上了元件编号，并突出了导线：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193135794.png" alt="image-20240311193135794" style="zoom:50%;" />

遗憾的是，我们无法通过标记来确定某些 SMD 元件的名称。如果不从电路板上拆下电容器，就无法确定大多数电容器的额定值。电阻器的额定值是用万用表测量的，因此可能会有误差。经过研究，我得到了测距仪的结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193231874.png" alt="image-20240311193231874" style="zoom:50%;" />

我把线路图分成了几张：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193313442.png" alt="image-20240311193313442" style="zoom:67%;" />

这里的一切都非常简单--它显示了 STM32 微控制器、一些捆绑元件、扬声器、键盘和一些 VLF 滤波器。它还显示了一个 DC-DC 电压转换器（DA1 芯片），它构成了测距仪的电源电压。

测距仪设计为使用 2 节电池工作，在操作过程中电池电压会发生变化。该转换器将输入电压 VBAT 转换成 3.5 V 的恒定电压（这一数值有些不同寻常）。要开关测距仪电源，需要使用装配在晶体管组件 DA2 上的一个节点。按下 S1 按钮后，DC-DC 将打开，然后微控制器通过 "MCU_power "线路上的信号开始保持 DC-DC 处于打开状态。

在一次测量过程中，我不小心烧毁了这个 DC-DC 转换器的芯片（万用表探头滑落并短路了其引脚）。由于无法确定芯片名称，我不得不将其拆焊，并从外部电压源为测距仪提供 3.5 V 电压。

电路板底部边缘有 8 个矩形焊盘，可用作调试或测试焊盘。我在原理图上用 "PMx "标记了它们。从原理图上可以看到，它们都与微控制器引脚相连。其中还有 UART 线路。本地固件在这些线路上没有活动，从示波器上看，TX 线路被配置为输入。电路板边缘还有 6 个针孔。原理图上标有 "Px"。测距仪电源线和 STM32 编程线都被引出到这些引脚上。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193405515.png" alt="image-20240311193405515" style="zoom:50%;" />

Si5351 振荡器的 PLL 芯片产生一个矩形信号，因此为了消除过多的谐波，PLL 输出的信号被送入两个相同的带通滤波器。图中还显示了一个装配在二极管 D1 上的信号混频器--它发出的信号用作相位差测量的参考。

从图中可以看出，PLL 输出的信号之一（"LASER_signal"）未经任何转换就输出到激光二极管 D3。另一方面，激光亮度（由流过它的电流大小决定）由 DA3 芯片和周围元件上的一个模拟节点来稳定。该节点从激光器内置的光电二极管（图中未显示）接收激光亮度的实际水平。通过 "laser_power "线，微控制器可以完全关闭激光，而通过连接到微控制器 DAC 的 "line10 "线，则可以调节激光亮度。通过示波器检查发现，测距仪在这条线路上始终保持 1.4 V 的电压值，在任何情况下都不会发生变化。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193439860.png" alt="image-20240311193439860" style="zoom:50%;" />

左侧显示的是线性电压源，它构成了光电二极管放大器 (DA5) 的电源电压。该芯片产生 3.3V 电压，因此其输入端电压必须高于 3.3V。据我所知，这就是电路的其余部分由 3.5V 供电的原因。

下图所示是一个组装在 DA4 芯片上的升压型 DC-DC 转换器，它为雪崩光电二极管提供了一个高电压（> 80V）。微控制器可以通过连接到控制器 DAC 的 "MCU_APD_CTRL "线改变该电压的大小。我找不到 DA4 芯片的名称，因此不得不通过实验来确定 APD 上的电压如何取决于控制信号的电平。结果发现这种依赖关系很奇怪，随着控制信号值的增加，输出电压会下降。在进一步的实验中，我使用了几个恒定的 DAC 值，因为我知道其相应的输出电压。

图的右侧是一块小型电路板的示意图。M1-M8 线表示连接两块电路板的接触焊盘。二极管 D6 是雪崩光电二极管 (APD)。它没有任何标签，因此无法确定其名称和特性。我只能说它采用 LCC3 封装。

通过线路 M8 向 APD 阴极施加高直流电压。还可以看到，来自 PLL 的高频信号通过电容器 C41 加到 "APD_modul "线上。这样，频率不同的光信号和 "APD_modul "信号在 APD 上混合。因此，APD 输出端会出现低频信号，该信号由带通滤波器（元件 C55、R41、R42、R44、C58、C59）提取。

然后，低频信号被运算放大器 DA6B (SGM8542) 放大。DA6B 输出的信号通过 M2 线传输到微控制器的 ADC。此外，该信号还经过晶体管 T6 的额外放大，并通过线路 M1 传输到微控制器。
这种阶跃放大是必要的，因为输入信号电平的变化范围非常大。

此外，在 APD 旁还安装了一个热敏电阻 R58，用于确定 APD 的温度。如前所述，APD 参数与温度密切相关，因此需要热敏电阻来通过软件补偿这种相关性。APD 在工作过程中会发热，甚至会改变其特性。例如，在室温下，由于自身发热，光电二极管的增益会下降 2 倍以上。

如果接收到的信号电平不够，微控制器就会增加 APD 上的电压，从而提高增益。在使用本地固件检查测距仪操作时，我发现只有两个输出电压电平 - 80 V 和 93 V。不过，当时我并没有意识到这些电平可能取决于 APD 的温度，也没有检查测距仪是否会在发热时改变任何控制信号。从电路板的照片中可以看到，电路板上有一些控制焊盘。我已在原理图和电路板上标记了它们："TPx"。其中可以区分出

* TP3、TP4 - 来自光电二极管放大器的低频信号。正是该信号传递着物体距离的信息。借助示波器可以看到，该信号频率为 5 kHz，包含一个常量分量。
* TP1 是参考信号。它的频率也是 5 千赫，包含一个常量分量。该信号的振幅很小，约为 100 mV。
* TP5 - 雪崩光电二极管的高压电源。

## 程序设计

在尝试使用控制器的本地固件之前，我决定用逻辑分析仪捕捉 STM32 和 PLL 之间通过 I2C 总线进行的通信。为此，我在总线上拉电阻上焊接了导线：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193613979.png" alt="image-20240311193613979" style="zoom:50%;" />

我能够拦截上述芯片之间的交换，并顺利解码传输包裹中的数据：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193700911.png" alt="image-20240311193700911" style="zoom: 50%;" />

分析结果表明，控制器始终只向 PLL 写入信息，而不读取任何信息。在信号电平良好的情况下，一个测量周期大约需要 0.4 秒，而在信号电平较差的情况下，测量周期则要长得多。

可以看出，微控制器向 PLL 传输的数据包非常大，周期约为 5 毫秒。
由于数据量很大，我专门编写了一个 Python 程序对其进行分析。该程序检测并计算包裹，确定包裹的大小和间隔时间。此外，程序还显示了写入传输字节的 PLL 寄存器名称。

结果发现，STM32 每 5 毫秒就会完全覆盖 PLL 主寄存器（数据包长度为 51 字节），导致 PLL 改变两个频率。测距仪没有对 PLL 进行初始化，也就是说，传输的数据包包含 PLL 的全部配置。在信号强度良好的情况下，一个测量周期包括 64 次数据传输。

接下来，我在程序中加入了根据数据包中传输的数据计算频率的功能。结果发现，测距仪在测量时使用了四种激光调制频率：

* 162.0 MHz
* 189.0 兆赫
* 192.75 兆赫
* 193.5 兆赫

外差频率（第二个 PLL 输出）始终比激光调制频率低 5 kHz。显然，4 个频率切换周期（每个周期 5 毫秒）可以测定一次距离。因此，经过 64 个周期后，测距仪进行了 16 次距离测量，然后对结果进行平均和过滤，从而提高了测量精度。

接下来，我开始为测距仪微控制器编写程序。

将编程器连接到测距仪后，电脑没有检测到微控制器。据我所知，这意味着在本地固件中，SWD 接口被编程禁用了。为了解决这个问题，我将 NRST 编程器线路连接到测距仪上，并在 ST-LINK 工具设置中选择了 "重置下连接 "模式。之后，计算机检测到了控制器，但不出所料，本地固件受到读取保护。为了将我的程序写入控制器，必须擦除控制器的闪存。

我在程序中执行的第一件事是为测距仪的模拟部分供电，打开激光器并设置其电流，以及打开 APD 电源电压。在确保所有电压正常后，我就可以对 PLL 进行试验了。在测试中，我只需将之前从测距仪中获得的数据写入 PLL。结果，在运行我的程序后，我发现测试点显示了一个 5kHz 的信号，其振幅明显取决于激光照射的物体类型。这意味着所有的模拟电子设备都在正常工作。

之后，我在程序中加入了通过 ADC 捕捉模拟信号的功能。需要注意的是，要测量信号的相位差，微控制器必须同时捕获主信号和参考信号的电平，或以恒定延迟捕获主信号和参考信号的电平。在 STM32F100 中，后一种选择可以通过 ADC 扫描模式实现。在这种情况下，应使用 DMA 将 ADC 的数据从逻辑上捕获到内存中，为了以给定的采样率捕获数据，应由一个定时器发出信号启动 ADC 转换。经过试验，我确定了以下捕获参数：

- ADC 采样频率 - 50 kHz、
- 采样次数 - 250。
- 信号捕捉总时间 - 5 毫秒。
- 控制器程序通过 UART 将捕获的数据传输到 PC。

为了处理捕获的数据，我用 C# 写了一个小程序：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311193822866.png" alt="image-20240311193822866" style="zoom:50%;" />

蓝色图为接收信号，橙色图为参考信号（该图中参考信号的振幅增加了 20 倍）。下图显示了接收信号的 FFT 变换结果。使用 FFT 可以确定信号的相位 - 您需要计算信号的相位频谱，并选择 5kHz 对应点的相位值。需要说明的是，我曾尝试在屏幕上显示相位频谱，但它看起来像噪声，所以我放弃了。

与此同时，实际上有两个信号进入微控制器--主信号和参考信号。这意味着需要使用 FFT 计算每个信号在 5 kHz 频率下的相位，然后从一个结果中减去另一个结果。结果就是所需的相位差，用来计算距离。我的程序会在频谱图下方显示这个值。

显然，使用 FFT 并不是确定单一频率信号相位的最合适方法。我决定改用 Goertzel 算法。引用维基百科的一段话：

> Goertzel 算法是离散傅里叶变换（DFT）的一种特殊实现方式，其形式为递归滤波....，与计算 DFT 所有频率成分的快速傅里叶变换不同，Goertzel 算法可以高效地计算单个频率成分的值。

这种算法的实现非常简单。与 FFT 一样，它可以返回复杂结果，因此可以计算信号的相位。使用该算法时，还需要计算主信号和参考信号的相位，然后计算它们的差值。同样的 PC 软件还可以使用赫兹尔算法计算信号的相位差和振幅。实验结果表明，在信号电平良好的情况下，相位差的测量精度可达 0.4 度（20 次测量的有效值）。

在下一阶段，我为微控制器编写了一个程序，计算三种不同调制频率的信号相位差（使用赫兹尔算法），并将结果传输到个人电脑。我稍后会解释为什么要使用这三种频率。由于计算是在微控制器上进行的，因此无需通过 UART 传输大量数据，从而大大提高了测量速度。我们为 PC 编写了一个程序，可以捕捉接收到的数据并记录下来。

在这一阶段，我注意到雪崩光电二极管的温度对相位差测量结果有很大影响。此外，我还注意到接收光信号的振幅也会影响测量结果。此外，当改变雪崩光电二极管的电源电压时，上述依赖关系也会发生明显变化。

坦率地说，在研究过程中，我意识到同时确定多个因素（电源电压、光信号振幅、温度）对相位差的影响是一项相当复杂的任务，理想情况下需要进行大规模和长时间的研究。这种研究需要一个气候室来模拟不同的工作温度，还需要一套滤光器来研究信号电平对结果的影响。还需要制作一个能够自动改变光信号水平的特殊工作台。温度降低时，APD 增益增加，以至于 APD 进入饱和模式--其输出信号从正弦波变为矩形或完全消失--这一事实使研究变得复杂。

我没有这样的设备，所以只能采用更简单的方法。我只在雪崩光电二极管 (Uapd) 的两个工作电压（82 V 和 98 V）下对测距仪的工作情况进行了研究。所有研究都是在 160 MHz 的激光调制频率下进行的。

在研究中，我认为光信号振幅和温度的变化会独立影响相位差测量结果。

为了改变接收到的光信号的振幅，我使用了一个特殊的活动台，上面附有一个挡板，可以与光电二极管的物镜重叠：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311194030083.png" alt="image-20240311194030083" style="zoom:50%;" />

温度变化的情况则更为复杂。首先，正如我前面提到的，APD 有明显的自热效应，温度传感器可以很好地监测到。为了给测距仪降温，我用一个装有风扇的泡沫箱把它盖起来，然后在上面放了一箱冷水。我还试着在阳台上给测距仪降温（当时的温度约为 10 °C）。从温度传感器的信号电平来看，两种方法得到的 APD 温度大致相同。加热更简单--我用热气流加热测距仪。为此，我使用了一个连接到冷却器上的电阻器--这样我就可以调节空气温度了。

我没有安装在测距仪上的热敏电阻的任何信息，因此没有将 ADC 转换结果转换成任何地方的度数。随着温度的升高，ADC 的电压水平也随之下降。结果如下：

* 随着 Uapd 的增加（即增益的增加），APD 对温度变化和信号电平变化的灵敏度明显增加。
* 当光信号的振幅减小时，会出现微小的相移--当振幅从最大值变为最小值时，相移约为 +2 度。
* 当 APD 冷却时，会出现正相移。

在 98 V 的电压下，我们得到了相移与温度的关系（以 ADC 单位表示）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311194147996.png" alt="image-20240311194147996" style="zoom:50%;" />

可以看出，当温度发生变化时（从约 15 度到 40 度），相位差的变化超过 30 度。对于 82 V 电压，这种关系几乎是线性的（至少在我进行测量的温度范围内是如此）。

因此，我得到了两个 Uapd 的图表，显示了温度与相移之间的关系。根据这些图表，我在微控制器中定义了两个数学函数，用来修正相位差值。这样，我就能够摆脱外部因素变化对测量正确性的影响。

下一步是利用获得的三个相位差来确定物体的距离。首先，我决定在个人电脑上完成这项工作。

问题出在哪里呢？正如我前面提到的，如果调制频率足够高，那么在距离测距仪一定距离时，就会出现模糊不清的情况。在这种情况下，要准确地确定物体的距离，不仅需要知道相位差，还需要知道在该距离内适合的整个信号相位的数量（N）。由此得出的距离由公式确定：
$$
D=\frac{1}{2}\left(N \cdot \lambda+\frac{\varphi \cdot \lambda}{2 \pi}\right)
$$
根据对测距仪工厂程序运行的分析，调制频率显然在 160-195 兆赫之间。测距仪电路很可能不允许用更低的频率对激光辐射进行调制（我没有核实这一点）。这就意味着，根据测距仪的相位差来确定物体距离的方法一定比简单地在高低调制频率之间切换要复杂得多。

值得注意的是，由于调制频率不同，信号的整数相位数在某些情况下可能有一个共同值 N，而在其他情况下则没有（N1、N2......）。我只知道解决这个问题的两种方法。

第一种方法是简单枚举 N 值及其与每个调制频率对应的距离。在这种搜索过程中，会搜索出彼此距离最重合的 N 值（由于相位差测量误差，可能无法获得完全重合）。这种方法的缺点是需要多次操作，而且对相位测量误差相当敏感。

第二种方法是利用调制频率接近的信号的节拍效应。让测距仪使用两个波长为 $\lambda_{1}$ 和 $\lambda_{2}$ 的调制频率，这两个频率彼此足够接近。可以假定，在与物体的距离上，整数周期数 N1 和 N2 相等，并且等于某个 N 值。在这种情况下，可以得到以下方程组：

$$
\left\{\begin{array}{l}D=\frac{1}{2}\left(N \cdot \lambda_{1}+\frac{\varphi_{1} \cdot \lambda_{1}}{2 \pi}\right) \\ D=\frac{1}{2}\left(N \cdot \lambda_{2}+\frac{\varphi_{2} \cdot \lambda_{2}}{2 \pi}\right)\end{array}\right.
$$
由此可以推导出 N 的值：
$$
N=\frac{\lambda_{2} \cdot \frac{\varphi_{2}}{2 \pi}+\lambda_{1} \cdot \frac{\varphi_{1}}{2 \pi}}{\lambda_{1}-\lambda_{2}}
$$
得到 N 值后，就可以计算出与目标物的距离。满足上述要求的最大距离由公式确定：

$$
D_{\max }=\frac{1}{2} \cdot \frac{\lambda_{1} \cdot \lambda_{2}}{\left|\lambda_{2}-\lambda_{1}\right|}
$$
从这个公式中我们可以看出，信号波长越接近，最大距离就越大。同时，即使在规定的距离内，在某些情况下也无法实现这一声明（N1=N2）。下面是一个简单的例子。

让我们 $\lambda_{1}=1.55$ м и $\lambda_{2}=1.5 \mathrm{~m}$，在这种情况下 $D_{\max }=11.6 \mathrm{~m}$。

但是，如果光的传播路径是 1.53 米，那么第一个波长的 N1 = 0，第二个波长的 N2 = 1。计算的结果是 N 值为负。利用以下知识可以抵消这种影响：
$$
\lambda_{1}>\lambda_{2}
$$
在这种情况下，我们可以修改方程组：
$$
\left\{\begin{array}{c}D=\frac{1}{2}\left(N 1 \cdot \lambda_{1}+\frac{\varphi_{1} \cdot \lambda_{1}}{2 \pi}\right) \\ D=\frac{1}{2}\left((N 1+1) \cdot \lambda_{2}+\frac{\varphi_{2} \cdot \lambda_{2}}{2 \pi}\right)\end{array}\right.
$$
利用该方程组可以求出 N1。这种方法的应用有一定的特殊性--调制信号的波长越接近，相位差测量误差对结果的影响就越大。由于这些误差的存在，N 值的计算可能不够精确，但至少接近真实值。

在确定物体的实际距离时，有必要对零点进行校准。校准的方法很简单--在距离测距仪一定距离的地方，即 "0 "处，放置一个能很好反射光线的物体。之后，程序应保存每个调制频率的相位差测量值。在今后的工作中，应从相应的相位差值中减去这些值。在我的距离测定算法中，我决定使用三个调制频率：162.5 MHz、191.5 MHz、193.5 MHz - 根据实验结果，这是最适合的频率数。

我的距离检测算法包括三个步骤：

* 检查相位差是否在 "零 "距离区域内。在接近于零的校准区域，由于测量误差，相位差值可能会从 0 度 "跳 "到 359 度，从而导致较大的距离测量误差。因此，当发现三个相位差同时接近于零时，可以认为测得的距离接近于零，从而避免计算 N 值。
* 通过频率为 191.5 MHz 和 193.5 MHz 的信号节拍初步计算距离。这些频率选得很近，因此确定区域足够大：$D_{max}=37.5 m$，但计算结果受测量误差的影响也很大。在接收信号电平较低时，误差可达几米（几个波长）。
* 使用频率分别为 162.5 MHz 和 191.5 MHz 的信号相位差，用蛮力法计算距离。由于在上一步中已经确定了近似距离，因此可以限制搜索值 N 的范围。这就降低了搜索的复杂性，并摒弃了可能出现的错误结果。

结果，我得到了这样一个 PC 程序：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311194852310.png" alt="image-20240311194852310" style="zoom:50%;" />

该程序可以显示测距仪传输的数据 - 以 ADC 单位表示的信号幅度、APD 电压、温度、三个频率的信号相位差值以及计算出的到目标物的距离。

按下 "ZERO"（归零）按钮即可在程序中进行归零校准。

对于自动运行的激光测距仪来说，信号增益的改变非常重要，因为当距离和反射系数发生变化时，信号电平会发生很大变化。在我的微控制器程序中，我通过在两个 APD 电源电压（82V 和 98V）之间切换来实现增益的改变。当我切换电压时，增益变化了约 10 倍。

我没有在两个 ADC 通道（"MCU_signal_high "和 "MCU_signal_low"）之间切换 - 微控制器程序始终只使用 "MCU_signal_high "通道的信号。

下一步，也就是最后一步，是将距离计算算法转移到微控制器上。由于该算法已经在个人电脑上进行过测试，因此并不难。此外，我们还必须在微控制器程序中添加校准零点的功能。微控制器将校准数据存储在闪存中。

我实施了两个不同版本的微控制器固件，它们在信号捕捉原理上有所不同。在其中一个较简单的版本中，微控制器从 ADC 捕捉数据时什么也不做。第二个固件更为复杂，它使用 DMA 将 ADC 的数据同时写入其中一个阵列，同时使用赫兹尔算法处理之前捕获的数据。与简单的固件版本相比，测量速度提高了近 2 倍。

微控制器通过 UART 将计算结果发送给计算机。为了便于分析结果，我又为电脑编写了一个小程序：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311194929172.png" alt="image-20240311194929172" style="zoom:50%;" />

## 成果

至此，我设法弄清了激光测距仪的电子元件是如何组织的，并为其编写了自己的开源固件。在编写固件的过程中，对我来说最重要的是最大限度地提高测量速度。不幸的是，提高测量速度会对测量精度产生明显影响，因此必须做出折衷。例如，本文末尾的代码每秒可进行 60 次测量，精度约为 5-10 毫米。

如果减少采集信号值的数量，就可以提高测量速度。我也曾获得过每秒 100 次的测量结果，但噪音的影响会大大增加。当然，与物体的距离和表面反射率等外部条件对信噪比有很大影响，因此也会影响测量精度。遗憾的是，当光信号过低时，即使增加 APD 增益也无济于事--随着增益的增加，噪声水平也会增加。

在实验过程中，我注意到雪崩光电二极管的外部照明也会显著增加噪声电平。在我的模块中，所有电子元件都是开放的，因此为了减少干扰，必须用不透明的东西将其遮住。

另一个值得注意的特点是，由于激光器和光电二极管透镜的光轴并不重合，因此在近距离（小于 0.7 米）时信号电平会明显下降。

原则上，这种形式的电子测距仪可以在某些项目中使用，例如用作机器人的距离传感器。

## 最后：您还能找到哪些激光测距仪？

在此，我想介绍一下其他激光测距仪的设计，您可以在网上找到相关信息。

* 首先值得一提的是 **BOSCH DLE50 激光测距仪**的逆向工程项目。这种测距仪的特殊之处在于它使用了一个定制的 CF325 芯片作为 PLL 振荡器，而互联网上并没有关于该芯片的文档，这就使逆向工程变得相当复杂。这种情况（定制芯片，没有文档）在激光测距仪中非常常见，但现在似乎正在发生变化--定制芯片开始被 "通用 "芯片所取代。这款测距仪使用的微控制器是 ATmega169P。

  这款测距仪的另一个特点是使用了一个由电磁铁控制的机械组件，可以形成 "光学短路"，即把激光器发出的光沿着已知路径重新定向到光电二极管。由于光路长度和反射系数已知，微控制器可以进行各种校准（振幅和相位）。在这个组件的运行过程中，激光测距仪会发出非常响亮的咔嗒声。

  在[这里](http://www.wookware.org/pics/dle50/)，您可以看到该测距仪的电子元件照片。

* 人们对 UT390B 激光测距仪的了解相当多。一些爱好者能够[逆向设计](https://github.com/erniejunior/UT390B_Arduino_Library)这种测距仪的调试 UART 接口协议，并学会控制其运行。甚至还有一个 [Arduino 库](https://github.com/erniejunior/UT390B_Arduino_Library)。您可以在这里阅读俄文版的[测距仪装置介绍](http://www.stasomel.ru/2014/03/blog-post.html)。从照片中可以看出，这种测距仪的电子装置非常简单，与本文中描述的装置类似。测距仪中使用的微控制器是 STM32F103C8。PLL 芯片：CKEL925（有相关文档）。


* 但目前还没有人能弄清新版 UT390B+ 测距仪的协议。这款测距仪的电路与[旧版本](https://hackaday.io/project/12767-peek-inside-uni-t-ut390b)不同。它甚至更接近我的测距仪的电路 - 它使用 STM32F030CBT6 微控制器和 PLL Si5351。如果仔细观察照片，就会发现测距仪上安装了两个激光器。显然，在一个测距仪中安装两个激光器在当今并不罕见。在对另一款测距仪的[描述](https://www.allaboutcircuits.com/news/teardown-tuesday-bluetooth-laser-distance-measurement/)中提到，其中一个激光器具有可见光辐射，仅用于 "指定目标"，而第二个激光器是红外线激光，用于测量距离。有趣的是，激光和光电二极管都使用同一个透镜。

* 另一款协议不明的测距仪是 BOSCH PLR 15。爱好者们已经试图找出它的协议，但至今无人成功。在此之前，我也曾试图[弄清](http://robotshop.com/letsmakerobots/laser-range-finder-hack)这种测距仪的工作原理，甚至部分重建了这种测距仪的电路。这次测距仪使用的微控制器是 STM32F051R6。但其中并没有其他高集成度的微芯片！不过，这里使用的光电探测器非常不寻常，我甚至从未见过这种装置：

  <img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311195531363.png" alt="image-20240311195531363" style="zoom: 67%;" />

  显然，它是一个片上系统，包含两个光电二极管（测量和参考通道）、光电二极管放大器、数字控制电子元件和 ADC。激光调制信号也来自它。光电探测器本身通过 SPI 与微控制器相连。我试着截取通过 SPI 传输的数据--有从控制器到传感器的命令，也有从传感器到控制器的信息包。

  如果在 Excel 中处理这些数据包，可以清楚地看到正弦波（即使用相位法测量距离）。这意味着该测距仪的信号处理由微控制器负责。然而，通过 SPI 可以获得大量信息，但无法确定进行测量的频率，因此即使从测距仪上读取距离也很困难。这里收集了博世 GLM 20 测距仪的一些[信息](https://www.eevblog.com/forum/projects/hacking-the-bosch-glm-20-laser-measuring-tape/)。


* **各种中国模块**。最近，中国网店上出现了大量激光测距模块（搜索 "激光测距模块 "或类似关键词即可找到）。在这些模块中，你可以找到与我的模块外观完全相同的模块，但它们的售价却是我的两倍（40 美元）。看来，这些都是相同的激光测距仪内核，只是修改了固件。有趣的是，在各种设计中，我多次发现测距仪有两个相同的 PLL 芯片（显然，这些芯片不是定制的）。

> * 翻译自俄语文章：https://habr.com/ru/articles/396357/
> * 项目地址：https://github.com/iliasam/Leuze_RS4_reverse_engineering

# Leuze RS4 激光扫描仪的逆向工程设计

前面我已经介绍了[激光测距传感器](https://habrahabr.ru/post/274879/)的逆向工程。这次我们将讨论一个更复杂的设备--Leuze RS4 激光扫描仪。和传感器一样，这台扫描仪也是在损坏的状态下送到我这里的，因此我必须恢复它的工作，并在此过程中改进它的某些特性，事实上，将它转换成另一种设备。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311130837235.png" alt="image-20240311130837235" style="zoom:67%;" />

[TOC]

## 那么这个激光扫描仪是什么呢？

Leuze RS4 是一款激光安全扫描仪，用于防止人员进入危险工作区域、防止生产车辆发生碰撞等。它具有相当不错的特性--最大范围：15/50 米（取决于操作模式），整个测量范围内的距离测量精度 - 5 毫米，角度分辨率 - 0.36 度，扫描速度 - 25 转/秒（25000 次测量/秒）。

值得注意的是，该扫描仪被定位为一种安全设备，即在内存中存储警报和警告区域的位置，当有物体进入这些区域时，扫描仪中的一个按键就会打开。要定制区域的位置，可以将扫描仪连接到电脑上，在屏幕上观察障碍物的位置。甚至还有一个 ROS 软件包，可以让您从该扫描仪获取数据。
我收到的扫描仪没有外壳，是拆卸下来的部件。扫描仪由于外壳受到强烈撞击而失灵；究竟是什么原因导致它停止工作，我还不清楚--也许是光学器件断开了，也许是某个连接器的触点脱落了，也许是编码器传感器移动了，也许是其他原因。我试着把所有部件组装在一起，扫描仪在本地软件中是可见的，但扫描无法启动。因此，我只有一个办法--尽可能恢复扫描仪电路，并为扫描仪微控制器编写自己的固件。

下面是我所拥有的部件的样子：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311130928657.png" alt="image-20240311130928657" style="zoom:50%;" />

它们在外壳中的位置应该是这样的（照片来自文件，可以看到设计和电子元件略有不同）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131215461.png" alt="image-20240311131215461" style="zoom:50%;" />

安装在扫描仪中心的扫描镜（上图中以蓝色标出）也是扫描仪的重要组成部分：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131125413.png" alt="image-20240311131125413" style="zoom:50%;" />

扫描仪结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131149338.png" alt="image-20240311131149338" style="zoom:50%;" />

从图中可以看出，整个扫描仪电子设备由独立的模块（板）组成，通过连接器和电缆连接。模块的数量相当多 - 电源模块（DC-DC）、接口模块、处理器模块、光电探测器模块（APD）、激光模块。此外，还有一个编码器模块和两个马蹄形电路板，乍一看很奇怪。这些都是您应该首先注意的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131243443.png" alt="image-20240311131243443" style="zoom:50%;" />

显然，其中一块电路板包含发光二极管，另一块包含光电二极管。起初我以为这是某种编码器，或者是某种检测激光的装置。但后来，在阅读了扫描仪的文档并详细查看了照片后，我意识到这是一个用于监测扫描仪保护玻璃表面状况的系统。

照片显示的是 LED 的孔：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131310121.png" alt="image-20240311131310121" style="zoom:50%;" />

通过测量光电二极管的信号电平，可以估算出保护玻璃的透光率。显然，该系统对扫描仪的运行并不重要，因此我没有继续使用这些电路板。

处理器模块是扫描仪最复杂的部分。这是从两侧看模块的电子元件：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131430059.png" alt="image-20240311131430059" style="zoom: 67%;" />

第一次看到电路板，我立即意识到扫描仪使用的是飞行时间（TOF）测距法--标记最大的芯片是 "ACAM TDC-GPX"，我以前听说过。TDC--"时间数字转换器"，即一种专门用于高精度测量时间间隔的芯片，正是这种芯片用于测量激光脉冲的 "飞行 "时间。电路板上还有一个英飞凌 C167 微控制器和一个外部 FLASH 存储芯片（这让我很高兴）和一个 ASIC（这让我很伤心）。下面我将详细介绍这个模块。

电源模块包含某种定制的多输出电压电隔离直流-直流转换器和一些电容器：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131509884.png" alt="image-20240311131509884" style="zoom:50%;" />

转换器的电源电压为 24 伏。其主要特点是将激光器和光电探测器工作所需的高压（~230V）输出到一个单独的小型连接器。

它还向主连接器输出以下电压：+5V、-5V、~15V，与 RS232 接口的另一个 +5V 电压电隔离。

## 扫描仪的光学部分

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131608136.png" alt="image-20240311131608136" style="zoom:50%;" />

乍一看扫描仪的光学系统，还不太清楚什么是什么。在这种情况下，照片中央带镜子的小窗口是用来输出激光束的，其周围的大块闪亮表面是安装在光电探测器镜头前的干涉滤光片的表面。这种滤光片只允许波长接近激光波长的辐射通过。扫描仪文档中就是这样显示的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131631760.png" alt="image-20240311131631760" style="zoom: 67%;" />

镜头本身安装在黑色塑料外壳内，因此不容易看到。激光器和光电探测器模块安装在这个外壳的末端，与上图中的外壳相对：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131656368.png" alt="image-20240311131656368" style="zoom:50%;" />

## 激光模块

激光模块视图（有些部件是我在绘制原理图时标注的）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131731546.png" alt="image-20240311131731546" style="zoom:50%;" />

如您所见，该模块的电路非常简单，因此我能够完全重建其原理图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311131825761.png" alt="image-20240311131825761" style="zoom:67%;" />

电路板上的大型圆形部件是一个专用激光发射器。遗憾的是，上面没有任何标记，因此我们无法找到任何相关文件。从扫描仪上的描述我们可以了解到："激光波长 - 905 nm"、"激光等级 - 1"、"脉冲持续时间 - 0.003 µs"、"重复频率 - 25 kHz"。通过还原模块的电路图并分析其工作原理，我们可以了解到这些信息：

* 激光发射器由稳定器限制的 143 V 电源电压持续供电。
* 发射器由模块输入端 "3 "的脉冲前沿触发。据我所知，脉冲的长度可以是任意的，模块本身会形成一个短脉冲。
* 发射器包含一个光敏传感器，在激光实际开启时输出一个脉冲。在测量 "飞行 "时间时，它发出的信号被用作参考（起始脉冲）。

所有激光控制都在 "LASER_PULSE "一行中完成。在大多数情况下，该线应为 "高 "电平。当在其前沿施加负脉冲时，DD1 触发器复位为 0，而在其后沿，触发器开始 "等待 "光电二极管的信号并启动激光。当光电二极管的信号出现时，触发器切换为 1。您可以看到两根同轴线通过连接器连接到模块上。这两根线用于传输从触发器到 TDC 芯片的差分信号。模块上还有五个 LED 指示灯。它们由处理器模块控制。

## 光电探测器模块

模块本身是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132002364.png" alt="image-20240311132002364" style="zoom:67%;" />

光电探测器本身的近距离照片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132022741.png" alt="image-20240311132022741" style="zoom:33%;" />

电路板一角的高压标志清楚地表明这里使用的是[雪崩光电二极管 (APD)](https://ru.wikipedia.org/wiki/%D0%9B%D0%B0%D0%B2%D0%B8%D0%BD%D0%BD%D1%8B%D0%B9_%D1%84%D0%BE%D1%82%D0%BE%D0%B4%D0%B8%D0%BE%D0%B4)--它们需要相当高的电压才能工作。

遗憾的是，光电探测器外壳上没有明显的标记。从光电二极管本身（中间）的徽章上，我们只能确定它是由太平洋硅传感器公司（First Sensor）制造的，但没有其他相关信息，可能是定制的。从照片上可以清楚地看出，这个光电探测器是一个混合光电探测器，即它包含一个内置放大器--在光电二极管上方清晰可见。显然，放大器和光电二极管都需要电源，电源通过底部的引脚提供（电容器焊接在引脚上）。最令人费解的是光电二极管左侧的小部件，有三根导线与之相连。进一步调查发现，这是一个模拟温度传感器。

这个模块比前一个要复杂得多，它使用多层印刷电路板，至少有 4 层，大部分信号线位于电路板的外层，这样就更容易分析了。在这个模块中，我恢复了大约 80% 的电路，其余的我并不太需要。

光电探测器模块的原理图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132142620.png" alt="image-20240311132142620" style="zoom:67%;" />

电路顶部是一个用于雪崩光电二极管的稳压线性高压源。它能产生至少高达 150V 的稳定电压。该源由 DAC DA1 (LTC1451) 控制。

由于扫描仪的基础是脉冲测距仪，因此光电探测器模块的主要任务是尽快检测从障碍物反射的相当微弱的激光信号。由于光信号的电平非常小，因此只能通过一个雪崩光电二极管进行检测，该二极管有自己的放大功能。在这种情况下，光电二极管发出的信号会被光电探测器内置的集成放大器额外放大。由于放大器内置在光电探测器外壳内，因此减少了干扰对有用信号的影响。光电探测器产生的信号（OUT_B）被传送到某个微电路 DA4，这显然是另一个高频放大器。之后，信号被传输到高速比较器 D1（MAX9601）的直接输入端。来自电阻分压器的参考信号（约 50 mV）被送入该比较器的反向输入端。

比较器输出端的信号是差分信号，通过同轴线直接传输到处理器模块板。

此外，放大器 DA4 输出端的信号被传输到某种峰值检波器，它 "记住 "接收脉冲的最大电平。我没有还原这个节点的电路，只画出了它的输出级（芯片 U1），其信号也传输到处理器模块。

我最不清楚的扫描仪部件之一是安装在射频放大器输出端的晶体管 Q3。从电路来看，需要它来开启放大器输出端的信号衰减功能。该晶体管可由来自处理器板（10 号线 - "digi"）的信号控制。

您会发现板上有一个 EEPROM 芯片。该芯片的所有信号引脚都与处理器板相连。显然，该芯片存储了每个光电探测器电路板独有的一些参数，并在测试电路板时写入其中。特别是，它可能是 APD 增益与电源电压的关系曲线、温度传感器输出电压与温度的关系曲线以及其他类似特性。

可以看出，光电探测器的电源可以通过在连接 DAC 和 EEPROM 的 CLK、CS、CS2 线路上设置一定的电平来控制。

电路板上有多个电路用于控制其状态。APD 电压电平、温度（7 号线）和比较器阈值均可监测。这些电压经运算放大器 DA3-DA5 转换后传送到处理器模块板。

## 返回处理器模块

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132212096.png" alt="image-20240311132212096" style="zoom:67%;" />

这个模块是所有模块中最复杂的，它包含大量的多引脚微型芯片，印刷电路板又是四层的，而且大部分信号线都位于内层，这就给重建电路带来了很大的困难。

很多时候，我们会发现线路走到了电路板的另一侧。为了快速找到某条轨道的连接位置，我不得不用这种刷子连接万用表（万用表处于拨号模式）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132232656.png" alt="image-20240311132232656" style="zoom:50%;" />

我恢复了大约 70% 的电路 - 其余的我并不太需要。处理器模块结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132258549.png" alt="image-20240311132258549" style="zoom:50%;" />

处理器模块的原理图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/Schematic%20Prints_mcu2.png" alt="Schematic Prints_mcu2" style="zoom:67%;" />

尽管我在任何地方都把这个模块称为 "处理器模块"，但它实际上是基于[英飞凌 SAK-C167CR-L33M 微控制器](http://www.infineon.com/cms/en/product/microcontroller/legacy-products-c500-c166-xc166-audo1-family/c166-registered-family/c167cr%E2%81%84sr/SAK-C167CR-LM+HA%2B/productType.html?productType=ff80808112ab681d0112ab6fbf9d277c)。它有 144 个引脚，采用相当古老的 C166 架构。这种微控制器没有自己的非易失性存储器，必须通过并行总线连接外部存储器。为此，扫描仪中安装了 M29F400B 闪存芯片（512K x 8 / 256K x 16）。此外，还有两个 RAM 芯片与微控制器相连 - IS61C6416AL-12 (64K x 16) 和 K6R4016C1D (256K x 16)。

我们可以注意到，地址总线与所有内存芯片的连接都是一位移位--内存的 A0 线与微控制器的 A1 线相连。这是由于地址总线上的地址是以字节为单位设置的，而控制器和存储器本身是 16 位的。为了使控制器能在不影响 16 位字中相邻字节的情况下将单字节写入 RAM，存储器芯片具有特殊的 UBn 和 LBn 线路。这种解决方案在带有并行总线的设备中非常常见，控制器文档中也有详细描述。

但处理器模块中的另一种解决方案我还不太清楚。如果查看闪存芯片 U1，就会发现芯片的 A14 线与地相连。而控制器地址总线的相应线路 A15 与芯片完全没有连接。因此，控制器只能访问一半的闪存。RAM2 芯片（DD3）的情况也完全类似。

RAM1 芯片（DD2）的情况有些不同--控制器线路 A15 也没有与之相连，但同时该芯片的所有地址输入端都与地址总线相连，因此控制器可以访问芯片的整个存储器。

现在值得注意的是逻辑元件 DX1、DX2 和 DD4 上的节点。这些芯片决定了微控制器选择哪个存储器芯片。可以看出，它们由以下信号控制：

* WRn - 写入信号，低电平有效。当需要向外部 RAM 存储器写入一些数据时，微控制器会在这条线上设置一个低电平。
* A15 - 同一条数据总线线路，不直接连接任何内存芯片。
* CSn0 是专用的芯片选择信号，有效电平为低电平。该线路与控制器内置的地址解码器相连。控制器复位后为低电平。
* RAM2_CE - 连接至控制器 GPIO，上拉至地。

下表很好地描述了该节点的运行逻辑：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132612262.png" alt="image-20240311132612262" style="zoom: 67%;" />

如图所示，根据 RAM2_CE 线的状态，微控制器将使用闪存或 RAM2 芯片 (DD3)，它们的地址空间是相同的。值得注意的是，这些芯片的内存大小相同。也许这样做是为了简化设备的固件更新。还有另一种选择--已安装的 RAM 工作速度是闪存的 3 倍，因此启动后控制器可以将闪存内容复制到 RAM2 中，然后从 RAM2 中执行程序。但 A15 行的高电平明确决定了控制器将与 RAM 芯片（DD2）一起工作。因此，在控制器的地址空间中，FLASH 和 RAM1 存储器交替工作：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132639091.png" alt="image-20240311132639091" style="zoom:50%;" />

红色高亮显示的 RAM 区域，前面已经提到过--在访问该区域时，控制器将实际访问位于地址（0x8000-0xFFFFFF）处的数据。
在这种情况下设置编译器并非易事，而且如上所述，会损失一半的闪存/RAM2 容量。扫描仪开发人员为什么不使用专门的 CSnX 控制器线路在 FLASH 和 RAM 芯片之间进行切换，这一点还不清楚。

正如我已经提到的，所使用的控制器没有闪存，因此也没有保险丝位。与数据总线相连的下拉电阻用于调整控制器的某些参数：数据和地址总线宽度、PLL 参数。控制器本身内置的上拉电阻器阻值较大（大于 100 Kohm），与整个总线相连。因此，由于外部电阻的存在，总线上设置了特定的信号组合，控制器在上电时读取这些组合。正是这种组合决定了所需的控制器设置。

在本例中，我们讨论的是电阻 R3-R6。所选电阻的配置与总线信号连接方案一致，并确保控制器的时钟频率为 33 MHz。

镜像编码器的脉冲信号通过 OR 逻辑元件 D6 输入微控制器的定时器输入端 "T2IN"。该芯片的第二个输入端与控制器的 GPIO 相连，因此可以关闭定时器输入端的脉冲信号。为什么需要这样的解决方案，为什么不能通过编程关闭定时器--我还是不明白。

现在我们应该关注 TDC 芯片（DD1）。扫描仪中安装的 TDC-GPX 芯片是 ACAM 所有芯片中最 "先进 "的。时间间隔测量精度高达 10 ps RMS。该芯片有 8 个 LVTTL 线路输入通道和 2 个 LVECL（差分）通道。该扫描仪使用 LVECL 输入通道，通过四根同轴电缆将激光模块和光电探测器模块的信号传输到这些输入通道，从而实现最高的时间测量精度。激光模块的信号输入 DStart/DStartN 输入端，开始计时。来自光电探测器模块的信号被馈送至输入端 DStop1/DStop1N、DStop2/DStop2N，并停止时间计数。从原理图中可以看出，停止信号同时应用于两个 TDC 通道，且极性相反。因此，不仅可以测量光脉冲 "飞行 "的持续时间，还可以测量接收脉冲的宽度。

TDC-GPX 的数据总线为 28 位，但可以切换为 16 位模式，这正是扫描仪所使用的模式。地址总线为 4 位，偏移 1 位，与内存芯片相同。DD8、DD9 和 U2 微电路用于形成芯片控制信号和电平匹配--微控制器工作电压为 5V，TDC 工作电压为 3.3V。总的来说，TDC 电源系统相当复杂，甚至可以自动调节电源电压。由于其复杂性，我没有绘制其原理图--我怀疑它与数据表差别不大。

我将进一步介绍微控制器和 TDC 的编程。

如前所述，电路板上有一个定制的 ASIC 芯片，上面刻有 "LEUZE98 "和 "WATCHDOG "字样。至于它代表什么，我们不得而知。可以看到，该芯片连接了一个 20MHz 的石英振荡器。在我能够对微控制器进行编程之后，我确保 ASIC 不会干扰微控制器的运行，并且没有还原 ASIC 接线图。据我所知，该芯片通过并行总线与控制器通信。可能是 ASIC 产生了 RESETn 复位信号，从而复位了控制器和 TDC。

尽管如此，我们还是必须详细处理一些电路。

结果发现，激光控制信号 "LASER_PULSE "可以由微控制器和 ASIC（使用晶体管 T1、T2 上的节点）共同形成。在这种情况下，当开关接通时，ASIC 会打开晶体管 T1，这样控制器就无法控制激光。因此，我不得不去掉电阻 R24，这样控制器就能正常控制激光器了。

镜像电机 "line_motor1 "的控制信号也来自 ASIC（通过二极管 D2）。因此，我不得不切断电路板上的轨道，将该信号直接连接到控制器的空闲 GPIO 引脚 - P3.15。

最奇怪的是，与安装在光电探测器模块板上的 DAC 相连的 "CS2 "线也与 ASIC 相连。因此，控制器无法独立设置 APD 电源电压和 APD 放大器开关。这样做可能是为了提高扫描仪的可靠性--错误的 DAC 设置可能导致 APD 故障。我还必须将这条线连接到 P3.4 控制器的空闲 GPIO 引脚上。

众所周知，激光模块上的三个 LED 由 ASIC 控制。另外两个指示扫描仪状态（工作区域内是否有障碍物）的 LED 由控制器控制 - 线路 LN1 和 LN2。这些线路也连接到接口模块板。

由于扫描仪可在安全应用中运行，因此处理器板上有大量节点用于诊断其状态。处理器（可能还有 ASIC）可以检测激光器的开机状态（使用芯片 U3）、监控多个电源电压的电平、APD 电源电压、APD 温度以及光电探测器板上的比较器阈值。

由于控制器 ADC 的参考电压为 4.1V，因此通过电阻分压器降低了部分测量电压，如右图所示。

现在值得详细考虑的是形成不寻常信号 "digi "的方法，我在前面介绍光电探测器模块时已经提到过。


下图同时显示了处理器模块（下）和光电探测器模块（上）的节点：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132847201.png" alt="image-20240311132847201" style="zoom:67%;" />

箭头表示各模块通过导线连接。下面我将按照我的理解来描述这些单元的工作原理。在光电探测器模块中，APD 输出的信号经 DA4 芯片放大后进入比较器 D1。如果比较器输入端的信号电平大于 50 mV，则比较器的输出被设置为高电平。比较器输出的信号被传送到处理器模块。首先，它进入 TDC 的输入端，对激光脉冲开始的时间进行计数。此外，该信号还被输入到 D 型触发器 DD1 的时钟输入端。 触发器的信号输入端始终设置为逻辑 1，触发器本身可通过控制器 "BASE5 "的 GPIO 线路重置为零。因此，比较器的工作会导致触发器锁存 "1"。该触发器有一个差分输出，其信号进入芯片 D3 的输入端，芯片 D3 将其转换为 LVTTL 格式。正是这个信号被输入到光电探测器模块的 "digi "输入端。如前所述，在我看来，该信号的出现会导致比较器输入端的信号电平减弱。

主要的问题是，为什么需要这样做，为什么实现起来如此困难？为什么不能在光电探测器模块板上制作这两个节点？

我只能表达我的假设。也许，应该对信号进行衰减，以避免比较器或振幅检测器进入饱和模式。也许是为了缩短接收脉冲的长度。对于这两种装置，光电探测器板上根本没有空间。另一种方案是，只有在信号通过同轴电缆到达 TDC 后才对其进行衰减，这就需要进行如此复杂的设计。
研究表明，在启动一个新的激光脉冲之前，有必要重置触发器，否则就无法接收脉冲。

## 接口模块

遗憾的是，我没有这个模块的精美照片。我只有这张：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311132935321.png" alt="image-20240311132935321" style="zoom:50%;" />

该模块是唯一可以连接到扫描仪外部的两个连接器。其中一个是 RS-232/RS-422，另一个为扫描仪、控制信号和安全电路供电。该模块包含 UART-RS232/RS485 转换器和电隔离光耦合器（安装在右图所示的单独小电路板上）、安全电路电源开关、测距模式控制线输入电路、电机控制电路和编码器信号转换器。电源模块和处理器模块以及编码器模块和镜像电机（通过模块底部的连接器连接，照片中看不到）都与该模块相连。接口模块的部分原理图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/Schematic%20Prints_1103775.png" alt="Schematic Prints_1103775" style="zoom:67%;" />

我只修复了该模块的部分电路（约 20%），因为我对安全所需的按键和输入线路不感兴趣。文件中提到了安全电路的电流限制、短路监控和其他功能，但其中有很多被搞砸的东西。

镜像电机的速度控制有些奇怪。速度调节是通过改变电机电源电压来实现的--一切都很清楚。但该电压是通过运算放大器上的某个积分链来调节的。为了增加电压，控制器会在 "line_mot1 "线上设置 0，为了降低电压则设置 1。显然，如果没有编码器通过控制器提供的持续反馈，电机要么停止，要么加速到最大速度。

结果发现，UART-RS232 LTC1387 UART-RS232 转换器芯片的速度相当慢--在 500 kbit/s 的速度下，数据是乱码。因此，我不得不拆下装有该芯片的小电路板，将 USB-UART 转换器直接连接到接口模块板上。

## 逆向工程过程本身

当我开始了解扫描仪的电子元件时，我最担心的是激光器或光电探测器会因撞击而损坏。同时，由于不熟悉微控制器和 ASIC，我也不确定能否让处理器模块正常运行。因此，我做的第一件事就是重建激光器模块的电路，然后是光电探测器模块。在我能够理解这些模块的电路并确定其连接器上所有引脚的用途之后，我就可以着手处理机模块了。在极端情况下，如果我无法启动它，我有一个想法，用 STM32 + TDC-GP2 芯片制作一个类似的模块。

显然，要测试模块，您需要在模块上安装的英飞凌 SAK-C167CR 微控制器上运行自己的程序。值得再次提醒的是，该控制器没有内置闪存。此外，该控制器没有任何专门的调试接口（包括 JTAG）。固件很可能是在生产现场用编程器写入外部闪存的。不过，事实证明，情况并没有那么糟--控制器有一个通过 UART 运行的引导加载器（"Bootstrap Loader"）。该引导加载器存储在控制器的内置引导光盘中，因此我手中的控制器中必须有它。它的工作方式比较特殊--要在启动时激活它，必须将数据总线 P0L.4 设置为低电平，然后控制器开始等待来自主机的字节 0x00。收到该字节后，加载器会自动确定波特率，并开始等待 32 字节的数据，然后将其复制到控制器的板载 RAM 中。收到数据后，控制器开始执行收到的程序（控制器的 16 个字）。

事实上，在这 32 个字节中，你需要塞入另一个加载器（"预加载器"），它将从主机接收主加载器 "外部加载器 "并开始执行。

我很幸运，有一个现成的 FLASHit 程序可以自动完成上述所有操作。内置加载程序的功能相当丰富--在它的帮助下，你可以自动确定所安装闪存的型号，编辑和查看控制器寄存器的内容，还可以查看 ADC 通道的状态。

我在电路板上找不到任何连接到控制器 P0L.4 线的测试焊盘，因此为了启动引导加载程序，我必须在这条线上焊接一个特殊的引脚。我把引脚本身粘在一个 RAM 芯片的外壳上。为了启动引导加载程序，需要通过 8 千欧电阻将该引脚连接到地线上。

将电路板连接到电脑并给处理器模块供电后，FLASHit 确实检测到了微控制器。然后，我用 Keil 编写了一个小程序来切换控制器的一个引脚，并将其写入 Flash。程序运行正常，ASIC 没有以任何方式进行干扰（我担心会有内置看门狗机制或总线冲突），因此我可以继续工作了。
之后，我重新构建了处理器模块原理图，这样就可以从整体上检查所有模块的运行情况。

我做的第一件事就是检查激光模块的运行情况--正如我之前写的那样，要启动一个激光脉冲，只需向该模块施加一个信号。激光器工作了--用手机摄像头可以看到它的闪烁。我还用示波器检查了模块是否能正常形成启动（参考）脉冲。

接下来我检查了光电探测器模块。在这里，我必须检查 DAC、雪崩光电二极管电压生成节点和光电探测器放大器电源控制节点的工作情况。所有这些都正常工作，因此我可以检查测距仪本身的运行情况。为此，我按照开发人员的意图组装了模块：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133254602.png" alt="image-20240311133254602" style="zoom:50%;" />

照片中，所有五个主要模块都围绕光学系统组装在一起。在这里，我安装了一个普通的反射镜，而不是原生的旋转镜。之后，我提交了一个通过 UART 控制激光器的书面程序，并设置了光电二极管的操作。结果，当在比较器的输入端启动激光时，我确实能够通过示波器检测到脉冲，其振幅明显取决于镜子前的障碍物类型！比较器也正常工作。测试的最后一个重要部分是检查 TDC 的工作情况。

安装在扫描仪中的 TDC-GPX 微电路设计相当复杂，可以在多种模式下工作。下图显示了其结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133339157.png" alt="image-20240311133339157" style="zoom: 67%;" />

可以看到，芯片包含 8 个独立通道，这意味着它最多可以接收 8 个停止信号。如果通道是差分的，则只能分析两个停止信号和一个启动信号。在这种情况下，芯片可以将测量通道合并，从而提高时间间隔测量的精确度：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133410605.png" alt="image-20240311133410605" style="zoom: 67%;" />

老实说，我并不喜欢这款芯片的文档。其中对许多事情的描述都比较肤浅，代码示例也难以理解。数据表中关于设置时间分辨率的部分充斥着一些 "神奇的数字"。该芯片也没有正常的 "应用说明"。此外，在扫描仪本身，我找不到 "EF1/EF1 "线与控制器的任何连接。根据这些线路上的状态，我们可以确定芯片已经完成了时间测量。正因为如此，我花了很长时间才启动了 TDC，但结果一切正常--启动激光时触发了 TDC，而 TDC 的结果显然取决于与障碍物的距离。这样，脉冲激光测距仪就正常工作了。剩下的工作就是把整个结构变成一个可以工作的激光扫描仪。

第一步是进行调整--组装好的测距仪在几米之后就无法 "看到 "障碍物了。光学系统看起来完好无损，但我不得不拆掉光学系统上的电路板，因此反射光无法被光电探测器上的透镜准确聚焦。

在对准之前，我为控制器编写了一个程序，该程序不仅可以确定距离，还可以使用模数转换器测量峰值检波器产生的信号幅度。对准的整个过程简化为光电探测器和激光板的平滑移动，以及寻找信号振幅最大的位置。对准的结果是大大提高了接收信号的振幅。此外，有必要注意脉冲测距仪固有的一些数据处理特性。

光电探测器形成的信号是模拟信号。为了将其转换为数字形式，并由 TDC 进一步处理，需要使用一个比较器，如果输入信号超过某个阈值，比较器就会切换。因此，由于输入信号的形状复杂，当信号的振幅发生变化时，在确定时间间隔时就会出现误差：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133546369.png" alt="image-20240311133546369" style="zoom: 67%;" />

从图中可以看出，振幅较小的信号会被延迟检测到。解决这个问题有多种方法，包括硬件和软件。我决定使用最简单的方法--根据信号振幅校正测量结果。为此，我必须收集信号振幅变化引起的时间测量结果变化的统计数据。为了在不改变其他参数的情况下改变信号振幅，我在透镜上使用了纸套，以减少照射到光电二极管上的光通量。结果就是这种依赖性：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133616706.png" alt="image-20240311133616706" style="zoom:50%;" />

在此基础上，我制作了一个修正表，控制器程序在确定与物体的距离时会使用该表中的数据。下一步是启动反射镜电机和编码器。前面我已经给出了镜子的照片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133642568.png" alt="image-20240311133642568" style="zoom: 50%;" />

镜子的电机是无集电极电机，与冷却器风扇所用的电机非常相似。它有三根导线，其中两根是电源线，另一根是脉冲速度信号线。所有这些电线都连接到接口模块上，电机产生的速度信号并不使用，而是根据编码器的数据进行控制。如图所示，电机轴上有一个透明圆盘，上面附有编码器标记。可以看到圆盘上有一个零标记。编码器安装在一块小电路板上，完全被金属屏蔽罩覆盖，因此无法确定其标签。不过，根据其尺寸和引脚布局，我确定它是一个 HEDS-9040 正交编码器：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133713428.png" alt="image-20240311133713428" style="zoom:50%;" />

从编码器电路板到接口模块有四根导线，但结果发现只用了其中三根--两根电源线和一根信号线。据我所知，电路板上有施密特触发器和一些逻辑，将来自通道 A、B 和索引通道（零标记信号）的数据组合在一起。这就是编码器电路板输出的信号和直接从编码器获取的分度信号的样子。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133739590.png" alt="image-20240311133739590" style="zoom:50%;" />

可以看到，在分度信号期间，编码器脉冲被抑制。事实证明，编码器电路板每转一圈产生 500 个脉冲，但编码器线路所连接的 T2 控制器的定时器能够在脉冲的两个边沿同时触发，这使得镜面每转一圈产生 1000 次中断。这一数值与扫描仪宣称的 0.36 度角分辨率相对应。

我将 T2 定时器设置为 "捕捉模式"，它可以测量编码器中断之间的时间间隔。这段时间用于检测镜子的 "零 "位置，并稳定电机速度。同时，通过计算中断次数来确定镜面位置。一旦编码器正常工作，我就可以启动电机速度控制，扫描仪就可以完全组装好了。由于电路板和光学元件的形状复杂，设计起来相当花哨：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133803461.png" alt="image-20240311133803461" style="zoom:50%;" />

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133815797.png" alt="image-20240311133815797" style="zoom:50%;" />

要组装这样的设计并不容易--扫描仪各个部件的精度非常重要。如果镜子的轴线与测距仪部件的光轴不重合，扫描平面就会严重扭曲或倾斜。

在测量物体的准确距离时，必须要有一些 "参考 "物体，而这些物体的距离是可以准确知道的。通过了解到它的 "飞行时间"，就可以准确地确定与零距离相对应的时间。由于扫描仪部件的温度变化，这个时间会发生变化，因此需要持续监测这个时间。为了解决这个问题，我在扫描仪中安装了一块特殊的黑板：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133855733.png" alt="image-20240311133855733" style="zoom:50%;" />

扫描板被涂黑，这样反射过来的光线就不会 "遮住 "光电探测器。根据手册，扫描仪的原始设计也有深色和浅色反射元件。它们用于控制扫描仪测距部分的运行，很可能也用于校准。

上图还显示了安装在电路板上的编码器。结果发现，编码器必须非常精确地相对于圆盘定位，这就带来了很多问题--即使编码器有很小的偏移也会导致脉冲丢失，尤其是索引脉冲。很有可能正是因为编码器的问题，扫描仪在撞击外壳后就停止了工作。

因此，扫描速度可以达到每秒 20 转。在 135 V 的 APD 电源电压下，10-15 米的距离检测是正常的。在 145 V 的电压下，通过对信号进行额外的过滤，可以测量到 30 米的距离（尽管我不确定这对光电探测器是否安全）。

值得注意的是，原装扫描仪的最大传输速度为 115200 位/秒，这只能让所有数据以大约每秒 11 转的速度传输。正如我所提到的，在我的固件中，数据传输速度为 500 kbit/s，这让我可以大大增加每秒传输的扫描次数。正是由于 UART 速度的限制，我才没有将扫描速率提高到原来的每秒 25 转。请注意，在最初的扫描仪设计中，数据是在扫描仪本身进行处理的，因此低数据传输速率并不会造成任何影响。由于扫描仪现在是在没有外壳的情况下工作，因此可以将扫描区域从原来设计的 190 度增加到 208 度。从扫描仪接收到的数据可视化：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311133942831.png" alt="image-20240311133942831" style="zoom:50%;" />

显然，这种扫描仪必须实现一些有用的功能，因此我决定用 ROS 在 SLAM 中对其进行测试，并将测试结果与[自制激光扫描仪](https://geektimes.ru/post/275442/)的结果进行比较。为此，我将它安装到了一台 Roomba 上，而这台 Roomba 之前已经安装了自制的扫描仪。安装在 Roomba 上的 Leuze 扫描仪视图（镜子是旋转的，所以看起来很模糊）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134019680.png" alt="image-20240311134019680" style="zoom:50%;" />

在 hector_slam 的帮助下，我们绘制了这张公寓地图（墙壁显示为黄色）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134046868.png" alt="image-20240311134046868" style="zoom:50%;" />

由于吸尘器在地板上运行，所以它能 "看到 "大部分家具。如果把吸尘器拿在手上，放在与腰部齐平的位置，就能看到这样的地图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134109250.png" alt="image-20240311134109250" style="zoom:50%;" />

在这种情况下，公寓墙壁的 "可见度 "更高。如果我们比较一下地图的质量，就会发现自制的扫描仪有更多的 "噪音 "线。这是因为自制的扫描仪采用三角测量原理，随着距离的增加，精度也会下降。遗憾的是，尽管扫描质量非常好，但这种扫描仪并不适合自主机器人使用--它的尺寸太大，功耗也太高（约 7.2 瓦）。

这种扫描仪还能用在哪里？早些时候，在讨论自制扫描仪时，经常有人问我制作 3D 扫描仪的可能性，现在是时候制作一个了！这时，相当高的扫描速度就派上用场了。当然，这种扫描仪的分辨率无法与使用三角测量原理测量距离的扫描仪（使用激光线或投影仪（SLS））相比，但它可以扫描大空间--房间、街道的各个部分。

为了将二维扫描仪转换成三维扫描仪，您需要为它提供多一个轴的旋转能力。我决定使用与[本文中的扫描仪](https://habr.com/ru/articles/382939/)相同的光束扫描原理来制作我的扫描仪。为此，我让 Leuze 扫描仪 "躺着"，使其扫描平面垂直于地面。接下来，我需要实现整个扫描仪绕轴平稳缓慢地旋转。主要的困难在于，扫描仪在旋转时不能出现跳动和扭曲，否则会导致扫描结果失真。事实证明，在家里很难制造出能够提供如此精确旋转的轴承装置。因此，我决定使用 VHS 磁带录像机头作为轴承单元--它包含两个轴承，精度非常高，可以承受扫描仪的重量。由此产生的结构由步进电机驱动。

组装好的 3D 扫描仪看起来是这样的：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134323918.png" alt="image-20240311134323918" style="zoom:50%;" />

扫描仪安装在三脚架上的视图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134351239.png" alt="image-20240311134351239" style="zoom:50%;" />

左侧是一个 12 伏的电池，它也是一个配重。由于 Leuze 扫描仪需要 24 伏电压才能工作，我不得不在扫描仪上安装一个基于 XL6009 芯片的 DC/DC 升压转换器。扫描仪的步进电机由 A4988 和 Arduino 模块控制，以设定的速度旋转。Leuze 扫描仪（通过 USB-UART 适配器）和 Arduino 都通过 USB 集线器与计算机相连，由计算机采集数据。在目前的形式下，扫描镜的旋转和整个扫描仪的旋转并不同步--扫描仪的旋转速度是这样选择的：当扫描仪旋转 0.36 度时，扫描镜至少有时间转三圈。由于没有速度同步，我必须从 Arduino 向 Leuze 扫描仪传输位置同步信息。这一点实现起来非常简单--当扫描仪旋转时，Arduino 会每隔 0.36 度改变其中一个引脚上的信号电平。该信号被传送到扫描仪的处理器模块（未使用的安全玻璃传感器连接器）。每次扫描仪包裹开始时，都会传输有关该信号状态的信息--这就是控制扫描仪的自编 PC 程序接收扫描仪移动信息并确定其旋转角度的方式。

扫描仪生成的单个 3D 扫描包含约 350,000 个点。当然，这与专业扫描仪相比要少得多，但仍然相当不错，尤其是将多个扫描点粘合在一起时。

例如：一个房间的单次扫描：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134445818.png" alt="image-20240311134445818" style="zoom: 67%;" />

例如，由多个房间拼凑而成的房间扫描图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134514210.png" alt="image-20240311134514210" style="zoom:67%;" />

入口通道的扫描部分：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311134537674.png" alt="image-20240311134537674" style="zoom:67%;" />
> * 翻译自俄语文章：https://habr.com/ru/articles/213749/
> * 项目链接：[habr.com/ru/post/213749/](https://habr.com/ru/post/213749/)

# 自制相位激光测距仪

在本文中，我将向您介绍我是如何制作激光测距仪及其工作原理的。我必须首先说明，这个结构只是一个模型，不能用于实际应用。制作它只是为了确保自己能够组装相位测距仪。

[TOC]

## 理论

我们经常会遇到这样的观点，即使用激光测量距离只能直接测量激光脉冲从激光到反射物体再返回的 "飞行 "时间。事实上，这种方法（称为脉冲法或飞行时间法，TOF）主要用于距离目标足够远（>100 米）的情况。由于光速非常快，因此很难在一个激光脉冲中精确测量光的传播时间和距离。光在大约 3.3 毫微秒的时间内传播 1 米，因此时间测量的精度必须达到纳秒级，尽管距离测量的精度仍将达到数十厘米。FPGA 和专用芯片可用于测量如此精确的时间间隔。

不过，还有其他激光测距方法，其中之一就是相位调制法。在这种方法中，与前一种方法不同的是，激光器持续工作，但其辐射是由一定频率（通常频率小于 500MHz）的信号进行振幅调制的。需要注意的是，激光波长保持不变（在 500 - 1100 nm 范围内）。光电探测器接收物体反射的辐射，并将其相位与来自激光的参考信号的相位进行比较。由于波的传播存在延迟，因此会产生相位偏移，测距仪会对其进行测量。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311113835551.png" alt="image-20240311113835551" style="zoom: 67%;" />

距离由公式确定：
$$
D=\frac{c}{2 f} \cdot \frac{\varphi}{2 \pi}
$$
其中，c 为光速，f 为激光调制频率，phi 为相移。这个公式只有在与物体的距离小于调制信号波长的一半（等于 c / 2f）时才有效。如果调制频率等于 10MHz，则测量距离可达 15 米，当距离从 0 米变为 15 米时，相位差将从 0 度变为 360 度。在这种情况下，1 度的相移变化相当于物体移动了约 4 厘米。如果超过这个距离，就会产生模糊性--无法确定测量距离内适合多少个波段。为了解决这个模糊问题，需要切换激光调制频率，并求解由此产生的方程组。

最简单的情况是使用两个频率，低频用于近似确定物体的距离（但最大距离仍然有限），高频用于以所需的精度确定距离--在相移测量精度相同的情况下，如果使用高频，距离测量的精度会明显提高。

由于测量高精度相移的方法相对简单，这类测距仪的距离测量精度可低至 0.5 毫米。对精度要求较高的测距仪--大地测量测距仪、激光卷尺、安装在机器人上的扫描测距仪--都采用了这种相位原理。

不过，这种方法也有缺点--连续运行的激光器的辐射功率明显低于脉冲激光器，因此无法使用相位测距仪进行长距离测量。此外，以所需精度测量相位需要时间，这也限制了设备的速度。

这类测距仪最重要的过程是测量信号的相位差，这决定了距离测量的精度。测量相位差的方法有很多种，包括模拟和数字两种。模拟方法要简单得多，而数字方法则更为精确。不过，数字方法较难测量高频信号的相位差--信号之间的时间延迟是以纳秒为单位测量的（这种延迟的发生方式与脉冲测距仪相同）。

为了简化任务，使用了外差信号转换技术--将光电探测器和激光器的信号分别与一个频率接近的信号混合，该信号由一个额外的信号发生器--外差信号发生器形成。调制信号和外差信号的频率相差千赫兹或兆赫兹单位。差频信号通过低通滤波器从接收到的信号中提取出来。带有外差装置的测距仪结构图示例如下。M - 激光调制信号发生器，G - 外差器。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311114049522.png" alt="image-20240311114049522" style="zoom:50%;" />

信号的相位差在这种变换中不会改变。之后，接收到的低频信号的相位差就更容易用数字方法测量了--您可以使用低速 ADC 轻松地将信号数字化，或者使用计数器测量信号之间的延迟（随着频率的降低，延迟会显著增加）。这两种方法都很容易在微控制器上实现。

还有一种测量相位差的方法--数字同步检测。如果调制信号的频率不是很高（小于 15 MHz），则可以使用与激光调制信号同步的高速 ADC 对信号进行数字化处理。根据科捷尔尼科夫定理，采样频率应是激光调制频率的两倍。不过，由于是对窄带信号进行数字化处理（除了调制频率外，ADC 输入端没有其他信号），因此可以使用子采样法，这样可以大大降低 ADC 采样频率--以兆赫为单位。显然，测距仪的模拟部分已经简化。

在[这里](http://www.hit.bme.hu/~papay/edu/Conv/pdf/Poujouly.pdf)（英文）和[这里](http://engjournal.ru/articles/359/html/files/assets/common/downloads/publication.pdf)（俄文）对这种方法进行了更详细的讨论（包括所有必要的公式）。第一篇文章指出，如果信号采样频率 (fsp) 与调制频率 (fo) 的关系如下：
$$
f_{S P}=\frac{4 f_{0}}{4 p+1}
$$
其中 p 为整数，相位计算过程大大简化。只需对信号 X[i] 进行 N 次采样，便可通过以下公式计算出相位差：
$$
\begin{array}{l}\mathrm{n}:=4,8 . . \mathrm{N} \\ \mathrm{S} 1:=\frac{4}{\mathrm{~N}} \cdot \sum_{\mathrm{n}} \mathrm{x}_{\mathrm{n}} \\ \mathrm{S} 2:=\frac{4}{\mathrm{n}} \cdot \sum_{\mathrm{n}} \mathrm{x}_{\mathrm{n}-1} \\ \mathrm{~S} 3:=\frac{4}{\mathrm{~N}} \cdot \sum_{\mathrm{n}} \mathrm{x}_{\mathrm{n}-2} \\ \mathrm{~S} 4:=\frac{4}{\mathrm{~N}} \cdot \sum_{\mathrm{n}} \mathrm{X}_{\mathrm{n}-3} \\ \phi:=\operatorname{atan}\left(\frac{\mathrm{S} 1-\mathrm{S} 3}{\mathrm{~S} 2-\mathrm{S} 4}\right)\end{array}
$$
我应该指出的是，上述两种方法经常同时使用--低频信号直接馈送到 ADC，高频信号通过外差转换转移到较低频率，然后也馈送到 ADC。我决定在测距仪布局中采用相位计的第二种变体，即使用 10MHz 的调制频率。

## 实践

我的测距仪的结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311114353194.png" alt="image-20240311114353194" style="zoom:50%;" />

实际上，整个设计由三部分组成--带微控制器的调试板、带激光器本身的激光信号放大器以及带放大器和滤波器的光电探测器。在上述理论中，假定激光发射是由正弦信号调制的。要使用控制器产生这样一个 10MHz 的信号并不容易，因此在我的设计中，我向激光器馈送了一个 10MHz 的蜿蜒信号。在对来自光电探测器的信号进行放大后，用一个调谐到 10MHz 频率的带通 LC 滤波器从接收信号中滤除多余的谐波，从而在滤波器输出端得到一个非常接近正弦信号的信号。

模拟部分（激光放大器和接收器部分）示意图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311114955097.png" alt="image-20240311114955097" style="zoom:50%;" />

电路取自 [Ronja](http://ronja.twibright.com/) 激光通信项目，[俄语描述](http://radus.laserlink.org/schem.html)。在该项目中，数据传输速度为 10Mbit，与所选调制频率一致。从原理图中可以看出，激光功率放大器是最简单的，它由 74HC04 芯片（包含 6 个反相器）构成。虽然芯片的安装并不完全正确，但仍能正常工作。通过激光器的电流由电阻限制（也不是最佳解决方案）。放大器的 5V 电源电压来自调试板。为了防止放大器的信号传入电路的其他部分，放大器的外壳由金属制成，所有导线都被屏蔽。激光器本身（红色）取自 DVD 驱动器，其功率可以设置得足够高，并保证在 10MHz 频率下工作。

接收器由一个光电二极管和一个放大器组成，放大器装配在一个场效应晶体管和一个高速放大器芯片上。由于随着距离的增加，光电二极管的照度会大幅降低，因此增益必须足够大（在本方案中，增益约等于 4000）。此外，随着频率的增加，光电二极管输出端的信号会明显下降（其电容受到影响）。我应该指出的是，在这个设计中，放大器是最重要也是最任性的部分。事实证明，它的放大能力明显不足。最初我以为可以改变增益（当信号过大时减弱信号），所使用的电路可以通过改变晶体管第二个栅极上的电压来实现。然而，事实证明，改变增益会使放大器引入的相移发生很大变化，从而降低距离测量的准确性，因此我不得不从电池向晶体管栅极提供 3V 电压，将增益设置为最大值。接收器需要 12V 电压才能工作，因此必须使用单独的电源为其供电。放大器对外部干扰非常敏感，因此也必须加以屏蔽。我从一个不能正常工作的光学传感器上拆下一个现成的外壳，将放大器放在其中（白色条带是铝箔，用于对光电二极管进行额外屏蔽）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311115123299.png" alt="image-20240311115123299" style="zoom: 67%;" />

需要注意的是，激光信号注入接收器会大大降低相位差测量的精度，因此必须确保没有这种注入。

测距仪中使用的 LC 滤波器取自[接收器](http://habrahabr.ru/post/204310/)。由于滤波器会切断信号中的恒定分量，而 ADC 无法感知负信号，因此必须使用电阻分压器 R15 和 R16 将其添加进来。分压器的恒定电压来自调试板（VCC）。

调试板是 STM32F4-DISCOVERY。之所以选择它，是因为要形成两个完全不同的频率，我需要一个足够高频率的信号发生器（STM32F4 的 PLL 可以提供超过 100MHz 的频率）。在连接调制频率和采样频率的公式中，我将系数 "p "取为 6，因此在调制频率为 10MHz 时，采样频率应为 1.6MHz。

为了产生 10MHz 频率，使用了 TIM2 定时器，它在 PWM 信号产生模式下工作。在系统频率为 160MHz 时，其周期为 16 "滴答"。ADC 从定时器 TIM8 接收启动请求。对于 1.6MHz 频率整形，其周期为 100 "滴答"。使用 DMA 从 ADC 获得的所有数据都存储在一个数组中，数组的大小必须等于 2 的 N 次方。ADC 和 DMA 两个定时器在上电时启动一次，不会再次关闭。因此，由于定时器的时钟来自一个时钟源，而测量信号的一个周期对应四个数据采样，因此数组中始终包含整数个信号周期。由于不希望停止 DMA（这可简化数据捕获的控制），因此当阵列的前半部分被填满时会产生一个中断。在检测到半数阵列已满后，控制器将其内容复制到另一个阵列中（为了简化程序，不使用主阵列的后半部）。然后，对接收到的数据进行处理 - 计算信号的平均振幅和相位，将相移重新计算为距离。得到的数值将显示在收银机的 LCD 显示器上，收银机也与调试板相连。

测距仪必须知道起点在哪里。为了校准测距仪，在测距仪开机时，将一个物体放在测距仪的 "零 "距离处，然后按下调试板上的按钮，测得的量程值就会存储在存储器中，然后再从测距仪的测量量程中减去这个值。

如上所述，我们无法实现自动增益控制。在这种情况下，改变接收信号的幅度会导致放大器相移的变化，从而产生额外的误差。因此，我不得不通过一个由伺服驱动旋转的机械挡板来调节光电二极管的光照度--光照度过高时，挡板会阻挡光通量。控制驱动器的 PWM 信号由 TIM3 定时器产生。

关于光学仪器。测距仪离不开它。从下面的照片中可以清楚地看到它的构造。激光器位于一个垂直安装的塑料管内。一个带有镜面棱镜的小套筒插入其中。套筒可以旋转、升高和降低，从而移动激光束。由于我估计增益不够，所以使用了一个大的菲涅尔透镜来接收信号。

由于激光器、透镜和光电二极管是同轴安装的，因此在距离很近的情况下，激光器会阻挡光电二极管发出的光束。为了弥补这种影响，我安装了第二个透镜（带框的放大镜），但这种影响并没有完全消除，因此在距离激光器约 50-70 厘米处可以观测到最大信号。

下面是一些现场图片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311115336992.png" alt="image-20240311115336992" style="zoom:50%;" />

在指示器上，第一个数字是以 ADC 为单位的振幅，第二个数字是距离电路板边缘的距离，以厘米为单位。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311115402882.png" alt="image-20240311115402882" style="zoom:50%;" />

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311115419355.png" alt="image-20240311115419355" style="zoom:50%;" />

这种测距仪的工作范围很小：1.5-2 米，取决于物体的反射系数。为了增大测距范围，您可以使用一个特殊的反射镜，将激光束射向反射镜。在实验中，我制作了一个光栅反射器，它由一个透镜组成，透镜的焦点是一张哑光纸。这种设计能将光反射回发出光的同一个点，但光束直径会增大。反射镜的照片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311115453474.png" alt="image-20240311115453474" style="zoom:50%;" />

使用反光板：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311115518841.png" alt="image-20240311115518841" style="zoom:50%;" />

从图中可以看出，到反射镜的距离为 6.4 米（实际距离约为 6.3 米）。由于信号增大，必须将激光束引向反射镜的边缘以减弱信号。

由此产生的测距仪的精确度为 1-2 厘米，相当于相移测量的精确度 - 0.2-0.5 度。同时，要达到这样的精度，数据平均时间必须太长--一次测量需要 0.5 秒。这可能是由于使用 PLL 产生信号的缘故--它的抖动相当大。虽然我认为对于一个自制的布局（其模拟部分的制作相当粗糙，导线也相当长）来说，即使是这样的精度也相当不错了。我应该指出的是，我在互联网上找不到任何现有的相位测距仪项目（至少有原理图），这也是我写这篇文章的原因。
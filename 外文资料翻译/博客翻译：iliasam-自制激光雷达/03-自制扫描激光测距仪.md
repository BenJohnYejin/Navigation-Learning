> * 翻译自俄语文章：https://habr.com/ru/articles/393685/
>
> * 项目链接：https://github.com/iliasam/DIY_laser_lidar

# 自制扫描激光测距仪

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311123055456.png" alt="image-20240311123055456" style="zoom:50%;" />

在本文中，我将讲述如何利用三角测量原理自制激光扫描测距仪，以及在机器人上使用它的经验。

[TOC]

## 为什么需要扫描测距仪？

目前，机器人技术中的室内导航方法并不多。使用激光扫描仪确定机器人在空间中的位置就是其中之一。这种方法的一个重要优点是无需在室内安装任何信标。与使用摄像头图像识别的系统不同，处理测距仪的数据不需要大量资源。但它也有一个缺点，那就是复杂，因此测距仪的价格也较高。

传统上，机器人使用激光扫描仪，利用相位或飞行时间原理来测量物体的距离。这些原理的实现需要相当复杂的电路和昂贵的部件，尽管其特点还算不错--利用这些原理，可以实现高扫描速度和远距离测量。但对于家用机器人实验来说，这种扫描仪并不合适--其价格从 1000 美元起。
这就需要使用三角测量原理的测距仪了。这种测距仪最早出现在 Neato 机器人吸尘器中：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311123228456.png" alt="image-20240311123228456" style="zoom: 50%;" />

很快，业余爱好者破译了这种测距仪的协议，并开始在他们的项目中使用。测距仪本身作为备件出现在 ebay 上，数量不多，价格约为 100 美元。几年后，一家中国公司生产出了 RPLIDAR 扫描测距仪，该测距仪以整机而非备件的形式供应。只是这些测距仪的价格相当高--400 美元。

## 自制测距仪

一了解到 Neato 测距仪，我就想自己也做一个类似的测距仪。最终，我成功了，并在 Roboforum 上介绍了组装过程。第一版测距仪：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311123321066.png" alt="image-20240311123321066" style="zoom: 67%;" />

后来，我又制作了另一个版本的测距仪，更适合在真正的机器人上使用，但我对它的性能并不完全满意。现在是时候制作第三个版本的测距仪了，下面将对它进行介绍。

## 扫描三角测量激光测距仪装置

测量物体距离的原理是测量击中物体的激光束与测距仪镜头之间的角度。知道了激光与镜头的距离（h）和测量的角度，就可以计算出物体的距离--角度越小，距离越远。[文章](https://sites.google.com/site/todddanko/home/webcam_laser_ranger)中的图片很好地说明了这一原理：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311123420336.png" alt="image-20240311123420336" style="zoom:50%;" />

因此，这种测距仪的关键光学部件是激光器、透镜和光电探测器条。由于测距仪是扫描式的，所有这些部件和控制电子元件都安装在一个旋转头上。可能会有这样的问题--既然可以安装旋转镜，为什么还需要旋转光学和电子元件呢？问题在于测距仪的精度取决于透镜与激光器之间的距离（基距），因此它必须相当大。因此，圆扫描需要一个直径大于基距的反射镜。带有这种反射镜的测距仪非常笨重。测距仪的扫描头通过轴承固定在固定基座上。旋转扫描头的电机安装在上面。测距仪还应包括一个编码器，以提供有关扫描头位置的信息。如您所见，Neato、RPLIDAR 和我自制的测距仪都是按照这个方案制造的。

自制测距仪最困难的部分是制作机械部分。在早期版本的测距仪中，机械部分给我带来的问题最多。难点在于扫描头的制作，它必须牢固地安装在轴承上，旋转时不能有跳动，同时还必须以某种方式传输电信号。

在第二版测距仪中，我通过使用旧硬盘的部件解决了前两个问题--光盘本身被用作扫描头的底座，而安装扫描头的电机已经含有优质轴承。同时，这也带来了第三个问题--电线只能从电机轴上的一个小孔中穿过。我设法自制了一个三线电刷组件，固定在这个小孔中，但这样设计出来的电刷既嘈杂又不可靠。还有另一个问题--没有线路来传输编码器信号，这种设计中的编码器传感器必须安装在机头上，而带有标记的编码器圆盘必须安装在一个固定的底座上。编码器圆盘并不坚硬，因此经常会出现问题。第二版测距仪的照片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311123507301.png" alt="image-20240311123507301" style="zoom:50%;" />

## 电子产品

原则上，三角测距仪的电子部分非常简单，只包含两个关键部件--光敏尺和微控制器。如果控制器的选择没有问题，那么标尺就要复杂得多。这种测距仪使用的光敏尺必须同时具有足够高的光敏度，能够高速读取信号，并且尺寸较小。消费类扫描仪中使用的各种 CCD 标尺通常都很长。条形码扫描仪中使用的标尺也不是最短和最快的。

在第一版和第二版测距仪中，我使用了 TSL1401 及其对应的 iC-LF1401 标尺。这些标尺尺寸合适，价格便宜，但只有 128 个像素。这对于精确测量 3 米以内的距离是不够的，只有亚像素图像分析功能才能挽救这一局面。在第三版测距仪中，我决定使用 ELIS-1024 标尺：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311123803850.png" alt="image-20240311123803850" style="zoom: 50%;" />

然而，要买到它并不容易。主要的电子产品供应商根本没有这些系列。我在淘宝网上买到的第一条线路无法使用。第二根我在阿里速卖通（18 美元）上买的，结果还能用。这两把尺子看起来都是焊接的--都有辐照触点，而且从标记来看，是 2007 年制造的。即使在大多数中国卖家的照片中，尺子也是一模一样的。看来，真正的新型 ELIS-1024 系列产品只能直接从制造商那里购买。

光敏 ELIS-1024 系列，顾名思义，包含 1024 个像素。它有一个模拟输出，非常容易控制。DLIS-2K 系列具有更好的特性。它具有类似的尺寸，包含 2048 个像素，并具有数字输出。据我所知，Neato 测距仪和 RPLIDAR 使用的就是这种产品。不过，它很难在自由销售中找到，即使在中国商店也不常出现，而且价格昂贵--超过 50 美元。

由于我决定使用带模拟信号输出的标尺，测距仪微控制器必须包含足够快的 ADC。因此，我决定使用一系列控制器 - STM32F303，它的成本相对较低，具有多个可同时工作的快速 ADC。结果，我就有了这个原理图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124154821.png" alt="image-20240311124154821" style="zoom: 50%;" />

来自线路（引脚 10）的信号具有相当高的恒定分量，必须使用分离电容器将其滤除。
接下来，需要对信号进行放大，为此使用了运算放大器 AD8061。远处物体发出的信号相当微弱，因此我们必须将增益设置为 100。

实验结果表明，即使在没有信号的情况下，所选运算放大器的输出端也会因某种原因产生约 1.5V 的电压，这不仅会影响结果的处理，还会降低信号振幅的测量精度。为了消除这种偏移，我不得不在 DUT 的反相输入端施加额外的电压。


电路板是双边的，在国内很难高质量地制作这样的电路板，因此我订购了中国生产的电路板（我必须一次订购 10 块）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124220536.png" alt="image-20240311124220536" style="zoom:67%;" />

在这个测距仪中，我使用了一个焦距为 16 毫米的廉价 M12 螺纹镜头。镜头使用现成的镜头架（如各种相机中使用的镜头架）安装在 PCB 上。该测距仪中的激光器是一个红外线（780nm）激光模块，功率为 3.5mW。起初我以为激光辐射需要调制，但后来发现使用的标尺没有必要这样做，所以现在激光一直处于开启状态。为了测试电子设备的性能，我组装了这个模仿测距仪扫描头的设计：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124300834.png" alt="image-20240311124300834" style="zoom:50%;" />

即使在这种形式下，也可以检查测距仪的距离测量精度。为了分析尺子产生的信号，我们编写了微控制器和 PC 的测试程序。标尺信号示例（物体距离 3 米）。

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124338870.png" alt="image-20240311124338870" style="zoom:50%;" />

最初的电路并不完全如上图所示。在实验过程中，我不得不对原始电路进行部分重新设计，因此，从照片中可以看到，有些部件必须采用铰链安装。

## 机械部件

电子设备调试完毕后，就到了制作机械部件的时候了。这一次，我没有使用硬盘机械部件，而是决定用倒入硅胶模具中的液态塑料来制作机械部件。这种技术在互联网上有详细介绍，包括 Giktimes。在我制作部件之后，我发现如果用 3D 打印机制作部件会更容易，制作出来的部件会更坚硬，而且有可能只制作一个部件，而不是两个。我没有 3D 打印机，所以我不得不向一些公司订购零件制作。测距仪扫描头部件之一的照片：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124628843.png" alt="image-20240311124628843" style="zoom:33%;" />

这部分是机头的底座。它由一个轴套和一个圆盘组成，轴套上随后安装轴承。圆盘用于安装转塔的第二部分，编码器圆盘也从下面粘在上面。轮毂和圆盘上有一个通孔，将购买的 6 线电刷组件插入其中--您可以在照片中看到它。照片中可以看到的导线可以相对于该组件的主体旋转。为了提高稳定性，有 2 对电刷线用于传输 GND 和 UART TX 信号。其余 2 条线用于传输电源电压和编码器信号。用于铸造该部件的硅胶模具：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124702466.png" alt="image-20240311124702466" style="zoom:50%;" />

扫描头的第二部分也是用同样的方法制作的。它用于将 PCB 和激光器连接到光盘上。遗憾的是，我没有这部分的照片，因此只能将其视为测距仪的一部分。


滚珠轴承用于将扫描头固定到测距仪的底座上。我使用的是廉价的国产 6806ZZ 轴承。坦率地说，我不喜欢轴承的质量--其内套筒的轴线与外套筒的轴线可能会有一个小角度的偏差，因此测距头也会有一些倾斜。轴承与圆盘部件和底座的安装如下所示。

我用 5 毫米厚的透明有机玻璃制作了底座。轴承、编码器传感器、测距仪电机和小电路板都安装在底座上。底座本身使用支架安装在任何合适的表面上。

这是测距仪底座从下面看的样子：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124728394.png" alt="image-20240311124728394" style="zoom:50%;" />

印刷电路板上有一个为电机供电的可调线性电压调节器，以及电刷组件的接线垫。测距仪的电源也连接在这里。与其他测距仪一样，电机通过被动轴转动扫描头。为了防止从轮毂上脱落，轮毂上有一个特殊的凹槽。从照片中可以看到，轴承是用三颗螺丝固定在底座上的。在扫描头上，轴承由套筒上的突出部分固定，并由同时固定电刷组件的其他螺钉压紧。编码器由一个印有圆点的纸盘和一个带有光电晶体管的反射式光耦合器组成。光耦合器通过底座上的支架固定，使圆盘的平面紧靠着光耦合器：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124753425.png" alt="image-20240311124753425" style="zoom:50%;" />

光耦合器发出的信号通过电刷传送到微控制器的比较器输入端。微控制器的 DAC 充当比较器的基准电压源。为了使测距仪能够检测到零角度位置，编码器圆盘上标有一个长标记，用于标记测座的零位置（在上图右侧可以看到）。


这就是组装好的测距仪的样子：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124820250.png" alt="image-20240311124820250" style="zoom: 50%;" />

俯视图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311124853526.png" alt="image-20240311124853526" style="zoom: 50%;" />

测距仪背面的连接器用于连接微控制器的固件。为了平衡扫描头，在扫描头的前端安装了一个大螺母，几乎可以完全消除扫描头旋转时的振动。

组装好的测距仪应进行调整--激光器的位置应使物体反射的光线落在光电探测器条上。两个塑料部件在激光槽下方有同轴孔。调节螺钉拧入孔中，靠在激光器外壳上。通过旋转这些螺钉，可以改变激光的倾斜度。通过在计算机程序中观察接收信号的形状和振幅，并改变激光器的倾角，就可以获得最大振幅的信号。

三角测量测距仪也需要校准，这一点我在前面已经写过：为了使用传感器测量距离，有必要对传感器进行校准，即确定传感器返回的结果与实际距离之间的联系规律。校准过程本身就是一系列测量，测量结果是一组从传感器到某个物体的距离及其相应的结果。

在这种情况下，校准是使用自制测距仪和激光卷尺对各种物体的距离进行一系列测量，然后对测量结果对进行回归分析，并得出数学表达式。

由此产生的测距仪有一个很大的缺点--由于缺乏激光发射调制，它在任何强光下都无法正常工作。正常的室内照明（即使是大功率的吊灯）不会影响测距仪的工作，但被太阳直接照射的物体表面的距离会被错误地测量出来。为了解决这个问题，测距仪应该配备一个干涉滤光镜，它只允许特定波长的光辐射 - 在这种情况下为 780 纳米。


自制测距仪的演变：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311125021931.png" alt="image-20240311125021931" style="zoom:50%;" />

测距仪的整体尺寸：

* 底座尺寸：88x110 毫米。
* 测距仪总高度：65 毫米（可通过降低支架高度减至 55 毫米）。
* 扫描头直径：80 毫米（像一张微型 CD 光盘）。

与其他三角测距仪一样，该测距仪的距离测量精度会随着距离的增加而急剧下降。在测量一个反射系数约为 0.7 的物体的距离时，我大致得到了这些精度特性：

| Расстояние | Разброс |
| :--------: | :-----: |
|    1 м     |  <1 см  |
|    2 м     |  2 см   |
|    5 м     |  7 см   |

测距仪的制造成本：

|      **Основание**       | DIY, $ | Опт., $ |
| :----------------------: | :----: | :-----: |
|    Пластина основания    |  1,00  |  0,50   |
|        Двигатель         |  0,00  |  1,00   |
|        Подшипник         |  1,50  |  1,00   |
|      Щеточный узел       |  7,50  |  5,00   |
|     Крепежные детали     |  0,00  |  2,00   |
| **Сканирующая головка**  |        |         |
| Контроллер STM32F303CBT6 |  5,00  |  4,00   |
|   Фотоприемная линейка   | 18,00  |  12,00  |
|  Остальная электроника   |  4,00  |  3,00   |
|          Плата           |  1,50  |  0,50   |
|         Объектив         |  2,00  |  1,50   |
|   Держатель объектива    |  1,00  |  0,50   |
|          Лазер           |  1,00  |  0,80   |
|    Пластиковые детали    |  3,00  |  2,00   |
|     Крепежные детали     |  0,00  |  1,00   |
|         *Сборка*         |  0,00  |  20,00  |
|        **Итого:**        | 45,50  |  54,80  |

第一栏是测距仪花了我多少钱，第二栏是如果商业化生产可能需要多少钱（非常粗略的估计）。

## 测距仪软件部分

在编写程序之前，有必要计算光接收尺工作的时钟频率。

在旧版测距仪中，扫描频率限制在 3 赫兹，而在新测距仪中，我决定将扫描频率提高到 6 赫兹（在选择标尺时已考虑到这一点）。测距仪每转一圈要进行 360 次测量，因此按照规定的速度，每秒应能进行 2160 次测量，这意味着一次测量应少于 460 µs。每次测量包括两个步骤--曝光（尺子累积光线）和读取尺子上的数据。读出信号的速度越快，曝光时间就越长，因此信号振幅也就越大。标尺时钟频率为 8 MHz 时，1024 个像素的读出时间为 128 µs，6 MHz 时为 170 µs。


STM32F303 系列微控制器的时钟频率为 72 MHz，最大 ADC 采样率为 6 MSPS（转换比特率为 10 位）。由于我想在 8 MHz 的线路时钟频率下测试测距仪的工作情况，因此决定使用两个 ADC 同时工作的 ADC 模式（双 ADC 模式 - 交错模式）。在这种模式下，ADC1 由外部信号源启动，然后在一段可配置的时间后启动 ADC2：

<img src="C:/Users/李郑骁的spin5/AppData/Roaming/Typora/typora-user-images/image-20240311125243966.png" alt="image-20240311125243966" style="zoom:50%;" />

从图中可以看出，ADC 采样的总频率是触发器频率（在本例中是 TIM1 定时器发出的信号）的两倍。同时，TIM1 还必须为光电探测器线路产生一个时钟信号，与 ADC 采样同步。要从一个定时器中获得频率相差 2 倍的两个信号，可以将其中一个定时器通道切换到TIM_OCMode_Toggle 模式，而第二个通道则应产生正常的 PWM 信号。


测距仪程序结构图：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311125328354.png" alt="image-20240311125328354" style="zoom:50%;" />

程序的关键部分是从标尺上采集数据并对其进行控制。从图中可以看出，这一过程是通过 TIM1、ADC1/2 和 DMA 的协同工作在硬件层面完成的。为了保持标尺曝光时间恒定，使用了工作在单脉冲模式下的 TIM17 定时器。


当与编码器相连的比较器被触发时，TIM3 定时器会产生中断。这将计算测距仪扫描头的旋转周期及其位置。TIM16 定时器的周期是根据所获得的旋转周期计算得出的，因此当扫描头旋转 1 度时就会产生中断。正是这些中断用于触发标尺曝光。


在 DMA 将 ADC 采集到的所有 1024 个值传输到控制器内存后，程序开始分析这些数据：首先以像素精度搜索最大信号的位置，然后使用重心搜索算法，以更高的精度（0.1 像素）搜索最大信号的位置。得到的数值存储在结果数组中。扫描头旋转一圈后，在过零点时，该数组将通过另一个 DMA 通道传输到 UART 模块。

## 使用测距仪

与之前的测距仪一样，该测距仪的工作质量也是通过自编程序进行检测的。下面是该程序根据测距仪操作结果生成的图像示例：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311125418444.png" alt="image-20240311125418444" style="zoom:50%;" />

然而，测距仪并不是放在桌子上就能使用的--它被安装在一台旧的 Roomba 400 吸尘器上，而不是第二版的测距仪：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311125437634.png" alt="image-20240311125437634" style="zoom:50%;" />

机器人还配备了一台 Orange Pi 电脑，用于控制机器人并与之通信。结果发现，由于测距仪电机的线性电源电压下陷较大，测距仪需要 6V 的电源电压才能以每秒 6 转的速度运行。因此，Orange Pi 和测距仪分别由不同的 DC-DC 转换器供电。

我使用 ROS 控制机器人并分析测距仪的数据。测距仪数据由一个特殊的 ROS 驱动程序（基于 Neato 测距仪驱动程序）处理，它通过 UART 接收测距仪数据，将其重新计算为物体距离（使用校准数据），并以标准 ROS 格式发布。这是机器人安装在地板上时在 rviz（ROS 数据可视化软件）中接收到的信息：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311125516886.png" alt="image-20240311125516886" style="zoom:50%;" />

单元边长为 1 米。数据输入 ROS 后，可以使用现成的软件包进行处理。为了绘制平面地图，我使用了 hector_slam。供参考：SLAM 是一种同时绘制地形图和确定机器人位置的方法。
绘制的平面地图示例（由于测距仪 "看到 "的是家具而不是墙壁，因此形状有点不寻常，而且并非所有房间都显示出来了）：

<img src="https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/image-20240311125541016.png" alt="image-20240311125541016" style="zoom: 67%;" />

ROS 允许将运行在不同计算机上的多个程序（ROS 术语中的 "节点"）整合到一个系统中。因此，只有 Roomba 和测距仪的 ROS 驱动程序可以在 Orange Pi 上运行，而数据分析和机器人控制则可以在另一台计算机上进行。同时，实验表明，hector_slam 在 Orange Pi 上运行良好，对处理器的负载也在可接受的范围内，因此组织机器人的完全自主操作是非常现实的。


借助测距仪的数据，SLAM 系统可以确定机器人在空间中的位置。利用机器人的位置数据和构建的地图，可以组织一个导航系统，将机器人 "引导 "到地图上的指定点。ROS 中有一个软件包可以完成这项任务，但遗憾的是，我一直没能让它正常工作。